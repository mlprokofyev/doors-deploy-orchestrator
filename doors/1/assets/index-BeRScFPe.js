(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();class Ae{constructor(){this.images=new Map,this.canvases=new Map}loadImage(t,e){return new Promise((s,i)=>{if(this.images.has(t)){s();return}const o=new Image;o.onload=()=>{this.images.set(t,o),s()},o.onerror=()=>i(new Error(`Failed to load asset: ${e}`)),o.src=e})}async loadAll(t){await Promise.all(t.map(e=>this.loadImage(e.id,e.path)))}registerCanvas(t,e){this.canvases.set(t,e)}get(t){return this.images.get(t)??this.canvases.get(t)}has(t){return this.images.has(t)||this.canvases.has(t)}getSize(t){const e=this.images.get(t);if(e)return{width:e.naturalWidth,height:e.naturalHeight};const s=this.canvases.get(t);return s?{width:s.width,height:s.height}:null}}const b=new Ae,zt="/doors/1/";async function Oe(a=`${zt}assets/data/assets.json`){try{const t=await fetch(a);if(!t.ok)throw new Error(`HTTP ${t.status}`);return((await t.json()).assets??[]).map(i=>({...i,path:`${zt}${i.path}`}))}catch(t){return console.warn("[AssetManifest] Failed to load manifest, returning empty:",t),[]}}const c={TILE_WIDTH:218,TILE_HEIGHT:109,CANVAS_WIDTH:960,CANVAS_HEIGHT:640,TILE_IMG_W:218,TILE_IMG_H:125,CHAR_SRC_W:113,CHAR_SRC_H:218,CHAR_DRAW_H:128,PLAYER_START_COL:1.4,PLAYER_START_ROW:2.8,PLAYER_SPEED:80,PLAYER_RUN_MULT:1.4,CAMERA_ZOOM_MIN:.8,CAMERA_ZOOM_MAX:2,CAMERA_ZOOM_STEP:.25,CAMERA_DEFAULT_ZOOM:1,CAMERA_IDLE_ZOOM:.8,CAMERA_IDLE_DELAY:5,MAP_COLS:6,MAP_ROWS:6,MAP_PAD_BACK_LEFT:.05,MAP_PAD_BACK_RIGHT:.05,MAP_PAD_FRONT_RIGHT:.3,MAP_PAD_FRONT_LEFT:.3,LIGHTING_ENABLED:!0,WINDOW_LIGHT_COL:1,WINDOW_LIGHT_ROW:2.8,WINDOW_LIGHT_HEIGHT:46,WINDOW_LIGHT_RADIUS:214,WINDOW_LIGHT_R:1,WINDOW_LIGHT_G:.65,WINDOW_LIGHT_B:.25,WINDOW_LIGHT_INTENSITY:.5,WINDOW_LIGHT_FLICKER:.3,DOOR_LIGHT_COL:1.05,DOOR_LIGHT_ROW:2.25,DOOR_LIGHT_HEIGHT:60,DOOR_LIGHT_RADIUS:160,DOOR_LIGHT_R:1,DOOR_LIGHT_G:.3,DOOR_LIGHT_B:.6,DOOR_LIGHT_INTENSITY:1.4,DOOR_LIGHT_FLICKER:1,WINDOW2_LIGHT_COL:2.7,WINDOW2_LIGHT_ROW:1.4,WINDOW2_LIGHT_HEIGHT:46,WINDOW2_LIGHT_RADIUS:214,WINDOW2_LIGHT_R:1,WINDOW2_LIGHT_G:.65,WINDOW2_LIGHT_B:.25,WINDOW2_LIGHT_INTENSITY:.5,WINDOW2_LIGHT_FLICKER:.3,PLAYER_SHADOW_RADIUS:15,PLAYER_FOOT_OFFSET:18,PLAYER_BLOB_SHADOW_RX:22,PLAYER_BLOB_SHADOW_RY:11,PLAYER_BLOB_SHADOW_OPACITY:.38,SHADOW_HEIGHT_FADE:.8,VOLUMETRIC_DIFFUSE:.8,VOLUMETRIC_RIM:.4,BOUNDARY_FOG_PADDING:-15,BOUNDARY_FOG_BACK_MULT:.4,FOG_WISPS_PER_EDGE:20,FOG_WISP_SIZE:220,FOG_WISP_OPACITY:.4,FOG_WISP_DRIFT_SPEED:.45,FOG_WISP_BREATH_SPEED:1,FOG_WISP_REACH:65,SNOW_PARTICLE_COUNT:3e3,SNOW_FALL_SPEED:40,SNOW_WIND_SPEED:50,SNOW_MIN_SIZE:1,SNOW_MAX_SIZE:4,SNOW_OPACITY:.85,SNOW_WOBBLE_SPEED:1.8,SNOW_WOBBLE_AMP:26,SNOW_DEPTH_LAYERS:12,SNOW_MAX_HEIGHT:500,SNOW_SPAWN_PADDING:4,DOG_WALK_SRC_W:172,DOG_WALK_SRC_H:96,DOG_IDLE_SRC_W:123,DOG_IDLE_SRC_H:123,DOG_SLEEP_SRC_W:120,DOG_SLEEP_SRC_H:80,DOG_DRAW_H:64,DOG_SHADOW_RADIUS:8,DOG_FOOT_OFFSET:4,DOG_SPAWN_DELAY:2,DOG_SPEED:60,DOG_SPAWN_COL:5.7,DOG_SPAWN_ROW:1.2,DOG_TARGET_COL:3,DOG_TARGET_ROW:3.7,DOG_FADE_DURATION:2,NPC_INTERACT_RADIUS:.6,NPC_ONBOARD_RADIUS:.6,CAMPFIRE_COL:2.5,CAMPFIRE_ROW:4.4,CAMPFIRE_DRAW_H:80,CAMPFIRE_LIGHT_RADIUS:110,CAMPFIRE_LIGHT_HEIGHT:25,CAMPFIRE_LIGHT_R:1,CAMPFIRE_LIGHT_G:.55,CAMPFIRE_LIGHT_B:.12,CAMPFIRE_LIGHT_INTENSITY:.7},Y=c.TILE_WIDTH,V=c.TILE_HEIGHT;function G(a,t){const e=document.createElement("canvas");e.width=a,e.height=t;const s=e.getContext("2d");return[e,s]}function kt(a,t,e,s,i){a.beginPath(),a.moveTo(t/2,0),a.lineTo(t,e/2),a.lineTo(t/2,e),a.lineTo(0,e/2),a.closePath(),a.fillStyle=s,a.fill(),i&&(a.strokeStyle=i,a.lineWidth=1,a.stroke())}function Le(){const[a,t]=G(Y,V);kt(t,Y,V,"#3a5a28","#2e4a20");const e=t.getImageData(0,0,Y,V);for(let s=0;s<e.data.length;s+=4)if(e.data[s+3]>0){const i=(Math.random()-.5)*16;e.data[s]=Math.min(255,Math.max(0,e.data[s]+i)),e.data[s+1]=Math.min(255,Math.max(0,e.data[s+1]+i)),e.data[s+2]=Math.min(255,Math.max(0,e.data[s+2]+i))}return t.putImageData(e,0,0),a}function Ce(){const[a,t]=G(Y,V);kt(t,Y,V,"#4a3a28","#3a2e20");const e=t.getImageData(0,0,Y,V);for(let s=0;s<e.data.length;s+=4)if(e.data[s+3]>0){const i=(Math.random()-.5)*20;e.data[s]=Math.min(255,Math.max(0,e.data[s]+i)),e.data[s+1]=Math.min(255,Math.max(0,e.data[s+1]+i)),e.data[s+2]=Math.min(255,Math.max(0,e.data[s+2]+i))}return t.putImageData(e,0,0),a}function Pe(){const[a,t]=G(Y,V);return kt(t,Y,V,"#1a3040","#162838"),a}function ke(){const[e,s]=G(48,80);return s.fillStyle="#4a3628",s.fillRect(20,40,8,40),s.fillStyle="#3a3a3a",s.beginPath(),s.arc(24,30,18,0,Math.PI*2),s.fill(),s.fillStyle="#2e2e2e",s.beginPath(),s.arc(18,22,12,0,Math.PI*2),s.fill(),s.beginPath(),s.arc(30,24,11,0,Math.PI*2),s.fill(),s.fillStyle="#6a2020",s.fillRect(12,18,3,3),s.fillRect(32,22,2,3),s.fillRect(20,12,3,2),e}function He(){const[e,s]=G(32,24);return s.fillStyle="#5a5a5a",s.beginPath(),s.ellipse(16,14,14,10,0,0,Math.PI*2),s.fill(),s.fillStyle="#6a6a6a",s.beginPath(),s.ellipse(14,12,10,7,-.3,0,Math.PI*2),s.fill(),e}function De(){const[e,s]=G(96,96);return s.fillStyle="#3a2a1a",s.fillRect(16,40,64,48),s.fillStyle="#5a5a5a",s.beginPath(),s.moveTo(8,42),s.lineTo(48,12),s.lineTo(88,42),s.closePath(),s.fill(),s.fillStyle="#4a4a4a",s.beginPath(),s.moveTo(8,42),s.lineTo(48,16),s.lineTo(88,42),s.closePath(),s.fill(),s.fillStyle="#2a1a0a",s.fillRect(40,62,16,26),s.fillStyle="#7a6a20",s.fillRect(22,52,10,10),s.fillRect(64,52,10,10),s.fillStyle="#3a2a1a",s.fillRect(26,52,2,10),s.fillRect(22,56,10,2),s.fillRect(68,52,2,10),s.fillRect(64,56,10,2),e}function Ge(a,t){const[o,n]=G(128,48);for(let r=0;r<4;r++){const l=r*32,h=r%2===0?0:-1,d=r;n.fillStyle=a,n.fillRect(l+11,16+h,10,16),n.fillStyle="#c8a878",n.fillRect(l+12,6+h,8,10),n.fillStyle="#5a4030",n.fillRect(l+11,4+h,10,5),n.fillStyle=t,n.fillRect(l+12,15+h,8,3),n.fillStyle=a,r%2===0?(n.fillRect(l+8,18+h,3,10),n.fillRect(l+21,18+h,3,10)):(n.fillRect(l+7,17+h,3,11),n.fillRect(l+22,19+h,3,9)),n.fillStyle="#4a3a2a",d===0?(n.fillRect(l+12,32,4,12),n.fillRect(l+17,32,4,12)):d===1?(n.fillRect(l+10,32,4,13),n.fillRect(l+18,32,4,11)):d===2?(n.fillRect(l+12,32,4,12),n.fillRect(l+17,32,4,12)):(n.fillRect(l+14,32,4,11),n.fillRect(l+15,32,4,13)),n.fillStyle="#5a3020",n.fillRect(l+11,43,5,4),n.fillRect(l+17,43,5,4)}return o}function We(){const[e,s]=G(32,48);return s.fillStyle="#8a8a90",s.fillRect(11,16,10,16),s.fillStyle="#c8a878",s.fillRect(12,6,8,10),s.fillStyle="#5a4030",s.fillRect(11,4,10,5),s.fillStyle="#8a3030",s.fillRect(12,15,8,3),s.fillStyle="#8a8a90",s.fillRect(8,18,3,10),s.fillRect(21,18,3,10),s.fillStyle="#4a3a2a",s.fillRect(12,32,4,12),s.fillRect(17,32,4,12),s.fillStyle="#5a3020",s.fillRect(11,43,5,4),s.fillRect(17,43,5,4),e}const le=64,Mt=80,ce=6;function Ne(a){let t=a;return()=>(t=(t*16807+0)%2147483647,(t-1)/2147483646)}function Fe(){const a=le,t=Mt,e=ce,[s,i]=G(a*e,t);for(let o=0;o<e;o++){const n=o*a,r=Ne(o*777+42);i.fillStyle="#1a1008",i.beginPath(),i.ellipse(n+a/2,t-6,20,5,0,0,Math.PI*2),i.fill();const l=t-16;i.fillStyle="#3a2210",i.fillRect(n+12,l+2,40,6),i.fillStyle="#4d3018",i.fillRect(n+13,l+2,38,2),i.fillStyle="#1a0e06",i.fillRect(n+12,l+2,4,6),i.fillRect(n+48,l+2,4,6),i.fillStyle="#352010";for(let p=0;p<16;p++)i.fillRect(n+14+p,l-p*.45+1,5,5);i.fillStyle="#3e2814";for(let p=0;p<16;p++)i.fillRect(n+45-p,l-p*.45+1,5,5);i.fillStyle="#30190c",i.fillRect(n+18,l+4,28,4),i.fillStyle="#4a2e16",i.fillRect(n+19,l+4,26,2);const h=l+1,d=["#ff3300","#cc2200","#ff5500","#ee4400","#ff6600","#ff4411"];for(let p=0;p<20;p++){const T=n+16+r()*32,w=h-2+r()*6,S=(o+p)%3;i.fillStyle=d[(p+S)%d.length],i.fillRect(Math.floor(T),Math.floor(w),2+p%3,2+p%2)}const u=i.createRadialGradient(n+a/2,h-4,3,n+a/2,h-4,26);u.addColorStop(0,"rgba(255,120,10,0.55)"),u.addColorStop(.4,"rgba(255,70,0,0.3)"),u.addColorStop(1,"rgba(255,30,0,0)"),i.fillStyle=u,i.fillRect(n,h-28,a,32);const g=h-4,y=a/2,f=a*2,m=t*2,[v,I]=G(f,m),_=[[200,30,0],[210,50,0],[230,80,0],[255,100,0],[255,130,20],[255,165,35],[255,185,60],[255,200,80],[255,215,110],[255,230,150],[255,240,185],[255,250,225]];for(let p=-16;p<=16;p++){const T=Math.abs(p)/16,w=(1-T*T)*42,S=(r()-.5)*14+Math.sin((o+p*.3)*1.5)*5,E=Math.max(4,w+S);for(let O=0;O<E;O++){const H=O/E,D=Math.sin(o*1.1+O*.25+p*.4)*(H*5),$=y*2+p*2+D,C=g*2-O*2;if(C<2||C>=m)continue;const X=Math.min(_.length-1,Math.floor(H*_.length)),[k,j,q]=_[X],x=H<.15?.9:1-H*.4;I.fillStyle=`rgba(${k},${j},${q},${x.toFixed(2)})`;const A=H<.5?4:H<.8?3:2;I.fillRect(Math.floor($),Math.floor(C),A,2)}}for(let p=-6;p<=6;p++){const T=Math.abs(p)/6,w=(1-T*T)*26+(r()-.5)*8;for(let S=0;S<w;S++){const E=S/w,O=Math.sin(o*1.3+S*.35)*(E*3),H=y*2+p*2+O,D=g*2-S*2-3;D<2||D>=m||(E<.25?I.fillStyle="rgba(255,170,50,0.85)":E<.5?I.fillStyle="rgba(255,200,90,0.8)":E<.8?I.fillStyle="rgba(255,235,150,0.75)":I.fillStyle="rgba(255,250,230,0.7)",I.fillRect(Math.floor(H),Math.floor(D),3,2))}}i.save(),i.filter="blur(1.2px)",i.globalCompositeOperation="lighter",i.drawImage(v,0,0,f,m,n,0,a,t),i.restore(),i.save(),i.globalAlpha=.45,i.drawImage(v,0,0,f,m,n,0,a,t),i.globalAlpha=1,i.restore();for(let p=0;p<7;p++){const T=n+y+(r()-.5)*28,w=g-22-r()*24-o*2.5;if(w<2||w>=t)continue;const S=["#ff6600","#ffaa22","#ffdd55","#ff8833","#ffcc44"];i.fillStyle=S[p%S.length],i.fillRect(Math.floor(T),Math.floor(w),2,2)}}return s}function Ue(){const[a,t]=G(24,24);return t.strokeStyle="#8B6914",t.lineWidth=3,t.lineCap="round",t.beginPath(),t.moveTo(4,20),t.lineTo(20,4),t.stroke(),t.strokeStyle="#A67C00",t.lineWidth=1,t.beginPath(),t.moveTo(5,19),t.lineTo(19,5),t.stroke(),a}function Be(){const[a,t]=G(32,32);return t.strokeStyle="#8B6914",t.lineWidth=4,t.lineCap="round",t.beginPath(),t.moveTo(4,26),t.lineTo(28,6),t.stroke(),t.strokeStyle="#A67C00",t.lineWidth=2,t.beginPath(),t.moveTo(5,25),t.lineTo(27,7),t.stroke(),a}function qe(){const[a,t]=G(24,24);return t.save(),t.translate(12,12),t.rotate(-Math.PI/4),t.fillStyle="#121814",t.fillRect(-9,-2,18,5),t.beginPath(),t.arc(-9,-2,3.5,0,Math.PI*2),t.arc(-9,3,3.5,0,Math.PI*2),t.arc(9,-2,3.5,0,Math.PI*2),t.arc(9,3,3.5,0,Math.PI*2),t.fill(),t.fillStyle="#A09A90",t.fillRect(-9,-2,18,4),t.beginPath(),t.arc(-9,-2,3,0,Math.PI*2),t.arc(-9,2,3,0,Math.PI*2),t.arc(9,-2,3,0,Math.PI*2),t.arc(9,2,3,0,Math.PI*2),t.fill(),t.fillStyle="#F5F0E8",t.fillRect(-8,-2,16,2),t.beginPath(),t.arc(-9,-2,2,0,Math.PI*2),t.arc(9,-2,2,0,Math.PI*2),t.fill(),t.fillStyle="#FFFFFF",t.fillRect(-3,-1,6,1),t.restore(),a}function je(){const[a,t]=G(32,32);return t.save(),t.translate(16,16),t.rotate(-Math.PI/5),t.fillStyle="rgba(20, 15, 10, 0.55)",t.fillRect(-13,-3,26,8),t.beginPath(),t.arc(-12,-2,5.5,0,Math.PI*2),t.arc(-12,4,5.5,0,Math.PI*2),t.arc(12,-2,5.5,0,Math.PI*2),t.arc(12,4,5.5,0,Math.PI*2),t.fill(),t.fillStyle="#8B7D6B",t.fillRect(-12,-2,24,6),t.beginPath(),t.arc(-12,-2,4.5,0,Math.PI*2),t.arc(-12,4,4.5,0,Math.PI*2),t.arc(12,-2,4.5,0,Math.PI*2),t.arc(12,4,4.5,0,Math.PI*2),t.fill(),t.fillStyle="#D8CFC0",t.fillRect(-12,-2,24,5),t.beginPath(),t.arc(-12,-2,4,0,Math.PI*2),t.arc(-12,3,4,0,Math.PI*2),t.arc(12,-2,4,0,Math.PI*2),t.arc(12,3,4,0,Math.PI*2),t.fill(),t.fillStyle="#F5F0E8",t.fillRect(-10,-2,20,2),t.beginPath(),t.arc(-12,-2,2.5,0,Math.PI*2),t.arc(12,-2,2.5,0,Math.PI*2),t.fill(),t.fillStyle="#FFFFFF",t.fillRect(-4,-1,8,1),t.restore(),a}function $e(){const[a,t]=G(24,24);return t.fillStyle="#888",t.beginPath(),t.ellipse(12,14,9,7,0,0,Math.PI*2),t.fill(),t.fillStyle="#AAA",t.beginPath(),t.ellipse(11,12,6,4,-.3,0,Math.PI*2),t.fill(),a}function Ye(){const[a,t]=G(24,24),e=9,s=6,i=e+s/2,o=13,n=t.createRadialGradient(i,o,2,i,o,12);n.addColorStop(0,"rgba(240, 160, 190, 0.45)"),n.addColorStop(.5,"rgba(220, 130, 170, 0.18)"),n.addColorStop(1,"rgba(200, 100, 140, 0)"),t.fillStyle=n,t.fillRect(0,0,24,24),t.fillStyle="rgba(255, 255, 255, 0.55)",t.fillRect(e,0,1,3),t.fillRect(e+2,0,2,1),t.fillRect(e+3,0,1,3),t.fillRect(e+5,0,1,3),t.fillRect(e-1,3,1,2),t.fillRect(e+s,3,1,2),t.fillRect(e-2,5,1,3),t.fillRect(e+s+1,5,1,3),t.fillRect(e-2,8,1,14),t.fillRect(e+s+1,8,1,14),t.fillRect(e-1,22,s+2,1),t.fillStyle="#16161c",t.fillRect(e+1,0,1,3),t.fillRect(e+4,0,1,3),t.fillStyle="#222228",t.fillRect(e,3,s,2),t.fillStyle="#38383e",t.fillRect(e+1,3,s-2,1),t.fillStyle="#f0f0f4",t.fillRect(e-1,5,s+2,1),t.fillStyle="#ccccda",t.fillRect(e-1,6,s+2,1),t.fillStyle="#9898a8",t.fillRect(e-1,7,s+2,1);const r=8,l=14;return t.fillStyle="#8a4860",t.fillRect(e-1,r,1,l),t.fillRect(e+s,r,1,l),t.fillRect(e,r+l,s,1),t.fillStyle="#e8a0b8",t.fillRect(e,r,s,l),t.fillStyle="#f4c0d4",t.fillRect(e,r,2,l-1),t.fillStyle="#fce0ec",t.fillRect(e,r+1,1,3),t.fillStyle="#c87898",t.fillRect(e+3,r+1,2,l-2),t.fillStyle="#a06078",t.fillRect(e+3,r+3,1,2),t.fillStyle="#c0586e",t.fillRect(e+1,r+8,4,5),t.fillStyle="#a84060",t.fillRect(e+2,r+9,2,3),t.fillStyle="#d48c9c",t.fillRect(e+5,r,1,l-1),a}function Ve(){const[a,t]=G(32,32),e=12,s=8,i=e+s/2,o=17,n=t.createRadialGradient(i,o,3,i,o,16);n.addColorStop(0,"rgba(240, 160, 190, 0.40)"),n.addColorStop(.5,"rgba(220, 130, 170, 0.15)"),n.addColorStop(1,"rgba(200, 100, 140, 0)"),t.fillStyle=n,t.fillRect(0,0,32,32),t.fillStyle="rgba(255, 255, 255, 0.50)",t.fillRect(e+1,0,1,4),t.fillRect(e+3,0,2,1),t.fillRect(e+4,0,1,4),t.fillRect(e+6,0,1,4),t.fillRect(e-1,4,1,3),t.fillRect(e+s,4,1,3),t.fillRect(e-2,7,1,4),t.fillRect(e+s+1,7,1,4),t.fillRect(e-2,11,1,18),t.fillRect(e+s+1,11,1,18),t.fillRect(e-1,29,s+2,1),t.fillStyle="#16161c",t.fillRect(e+2,0,1,4),t.fillRect(e+5,0,1,4),t.fillStyle="#222228",t.fillRect(e,4,s,3),t.fillStyle="#38383e",t.fillRect(e+1,4,s-2,1),t.fillStyle="#f0f0f4",t.fillRect(e-1,7,s+2,1),t.fillStyle="#ccccda",t.fillRect(e-1,8,s+2,2),t.fillStyle="#9898a8",t.fillRect(e-1,10,s+2,1);const r=11,l=18;return t.fillStyle="#8a4860",t.fillRect(e-1,r,1,l),t.fillRect(e+s,r,1,l),t.fillRect(e,r+l,s,1),t.fillStyle="#e8a0b8",t.fillRect(e,r,s,l),t.fillStyle="#f4c0d4",t.fillRect(e,r,3,l-1),t.fillStyle="#fce0ec",t.fillRect(e,r+1,2,4),t.fillStyle="#fff0f4",t.fillRect(e+1,r+2,1,2),t.fillStyle="#c87898",t.fillRect(e+4,r+1,3,l-2),t.fillStyle="#a06078",t.fillRect(e+4,r+4,2,3),t.fillStyle="#c0586e",t.fillRect(e+2,r+10,5,7),t.fillStyle="#a84060",t.fillRect(e+3,r+12,3,4),t.fillStyle="#983855",t.fillRect(e+4,r+13,2,2),t.fillStyle="#d48c9c",t.fillRect(e+7,r,1,l-1),a}function Xe(){const[a,t]=G(7,5);return t.fillStyle="#E89028",t.fillRect(1,0,5,1),t.fillRect(2,1,3,1),t.fillRect(3,2,1,1),t.fillStyle="#C06A16",t.fillRect(0,0,1,1),t.fillRect(6,0,1,1),t.fillRect(1,1,1,1),t.fillRect(5,1,1,1),t.fillRect(2,2,1,1),t.fillRect(4,2,1,1),t.fillRect(3,3,1,1),a}function ze(){const[a,t]=G(32,32);return t.fillStyle="#888",t.beginPath(),t.ellipse(16,18,12,9,0,0,Math.PI*2),t.fill(),t.fillStyle="#AAA",t.beginPath(),t.ellipse(14,15,8,5,-.3,0,Math.PI*2),t.fill(),a}function Ke(){const e=document.createElement("canvas");e.width=20,e.height=16;const s=e.getContext("2d");s.fillStyle="#f0e4c8",s.beginPath(),s.moveTo(3,1),s.lineTo(17,1),s.lineTo(18,14),s.lineTo(2,14),s.closePath(),s.fill(),s.strokeStyle="rgba(120, 90, 50, 0.4)",s.lineWidth=1,s.stroke(),s.fillStyle="#e0d4b0",s.beginPath(),s.moveTo(15,14),s.lineTo(18,14),s.lineTo(18,11),s.closePath(),s.fill(),s.strokeStyle="rgba(120, 90, 50, 0.3)",s.stroke(),s.fillStyle="rgba(80, 55, 30, 0.5)";for(let i=4;i<=12;i+=2){const o=i===4?6:5,n=i===12?12:15;s.fillRect(o,i,n-o,1)}return s.fillStyle="rgba(160, 50, 40, 0.7)",s.beginPath(),s.arc(10,13,1.5,0,Math.PI*2),s.fill(),e}function Ze(){b.registerCanvas("tile_grass",Le()),b.registerCanvas("tile_dirt",Ce()),b.registerCanvas("tile_water",Pe()),b.registerCanvas("obj_tree",ke()),b.registerCanvas("obj_rock",He()),b.registerCanvas("obj_house",De());const a=Ge("#8a8a90","#8a3030");b.registerCanvas("char_walk_south",a),b.registerCanvas("char_walk_north",a),b.registerCanvas("char_walk_east",a),b.registerCanvas("char_walk_west",a);const t=We();b.registerCanvas("char_idle_south",t),b.registerCanvas("char_idle_north",t),b.registerCanvas("char_idle_east",t),b.registerCanvas("char_idle_west",t),b.registerCanvas("campfire_anim",Fe()),b.has("item_stick")||(b.registerCanvas("item_stick",Ue()),b.registerCanvas("item_stick_world",Be())),b.has("item_bone")||(b.registerCanvas("item_bone",qe()),b.registerCanvas("item_bone_world",je())),b.has("item_stone")||(b.registerCanvas("item_stone",$e()),b.registerCanvas("item_stone_world",ze())),b.registerCanvas("interact_marker",Xe()),b.has("obj_note_paper")||b.registerCanvas("obj_note_paper",Ke()),b.has("item_pink_lighter")||(b.registerCanvas("item_pink_lighter",Ye()),b.registerCanvas("item_pink_lighter_world",Ve()))}class Qe{constructor(t,e,s){this.objects=[],this.cols=t,this.rows=e,this.tileDefs=s,this.tiles=Array.from({length:e},()=>Array.from({length:t},()=>0))}setTile(t,e,s){t>=0&&t<this.cols&&e>=0&&e<this.rows&&(this.tiles[e][t]=s)}getTileDef(t,e){if(!(t<0||t>=this.cols||e<0||e>=this.rows))return this.tileDefs[this.tiles[e][t]]}isTileWalkable(t,e){const s=this.getTileDef(t,e);return!!s&&s.walkable}collidesWithObject(t,e,s,i){for(const o of this.objects){if(!o.solid)continue;const n=(o.solidCols??1)/2,r=(o.solidRows??1)/2;if(Math.abs(t-o.col)<s+n&&Math.abs(e-o.row)<i+r)return!0}return!1}isWalkable(t,e){return this.isTileWalkable(t,e)}addObject(t){this.objects.push(t)}removeObjectById(t){const e=this.objects.findIndex(s=>s.id===t);return e>=0?(this.objects.splice(e,1),!0):!1}}function Je(){const a=c.MAP_COLS,t=c.MAP_ROWS,e=new Qe(a,t,[{assetId:"tile_grass",walkable:!0}]);return e.addObject({col:4.5,row:3.1,assetId:"obj_tree_med_snow",width:438,height:600,srcW:511,srcH:700,anchorY:.92,solid:!0,solidCols:.9,solidRows:.9,shadowRadius:35}),e.addObject({col:3.5,row:.7,assetId:"obj_tree_snow_big_1",width:438,height:600,srcW:511,srcH:700,anchorY:.92,solid:!0,solidCols:.9,solidRows:.9,shadowRadius:45}),e.addObject({col:.5,row:4.9,assetId:"obj_tree_pine_snow",width:438,height:652,srcW:625,srcH:931,anchorY:.92,solid:!0,solidCols:.9,solidRows:.9,shadowRadius:35}),e.addObject({id:"stick_pile_1",col:.3,row:3.1,assetId:"obj_sticks_snow_rotated",width:130,height:80,srcW:258,srcH:158,anchorY:.85,solid:!0,solidCols:.1,solidRows:.3,shadowRadius:0}),e.addObject({id:"stick_pile_2",col:2.8,row:2.2,assetId:"obj_sticks_snow",width:130,height:80,srcW:258,srcH:158,anchorY:.85,solid:!0,solidCols:.2,solidRows:.1,shadowRadius:0}),e.addObject({col:c.CAMPFIRE_COL,row:c.CAMPFIRE_ROW,assetId:"obj_campfire",width:140,height:90,srcW:182,srcH:116,anchorY:.5,solid:!1,shadowRadius:20,groundLayer:!0}),e.addObject({col:4.2,row:.8,assetId:"obj_barrel_snow",width:80,height:82,srcW:124,srcH:127,anchorY:.88,solid:!0,solidCols:.35,solidRows:.35,shadowRadius:22}),e.addObject({id:"wall_note",col:2,row:2.7,assetId:"obj_note_paper",width:30,height:33,srcW:51,srcH:56,anchorY:4.1,solid:!1,depthBias:-100,shadowRadius:0}),e.addObject({col:1.5,row:1.5,assetId:"obj_house",width:600,height:600,srcW:890,srcH:890,anchorY:.82,solid:!0,solidCols:2,solidRows:2,shadowPoints:[{dx:-.64,dy:-.64,radius:54},{dx:0,dy:-.64,radius:60},{dx:.64,dy:-.64,radius:54},{dx:-.64,dy:0,radius:60},{dx:0,dy:0,radius:69},{dx:.64,dy:0,radius:60},{dx:-.64,dy:.57,radius:54},{dx:0,dy:.57,radius:60},{dx:.64,dy:.57,radius:54},{dx:0,dy:-1,radius:43}]}),e.addObject({col:1.1,row:2.3,assetId:"obj_door",width:60,height:140,srcW:90,srcH:208,anchorY:.92,solid:!1,depthBias:50,shadowRadius:0}),e}class ts{constructor(){this.x=0,this.y=0,this.zoom=c.CAMERA_DEFAULT_ZOOM,this.viewportW=c.CANVAS_WIDTH,this.viewportH=c.CANVAS_HEIGHT,this.targetX=0,this.targetY=0,this.followSmoothing=6,this.targetZoom=c.CAMERA_DEFAULT_ZOOM,this.zoomSmoothing=3}setViewport(t,e){this.viewportW=t,this.viewportH=e}follow(t,e){this.targetX=t,this.targetY=e}snap(){this.x=this.targetX,this.y=this.targetY}update(t){const e=1-Math.exp(-this.followSmoothing*t);this.x+=(this.targetX-this.x)*e,this.y+=(this.targetY-this.y)*e;const s=1-Math.exp(-this.zoomSmoothing*t);this.zoom+=(this.targetZoom-this.zoom)*s}setTargetZoom(t){this.targetZoom=Math.max(c.CAMERA_ZOOM_MIN,Math.min(c.CAMERA_ZOOM_MAX,t))}worldToScreen(t,e){return{x:(t-this.x)*this.zoom+this.viewportW/2,y:(e-this.y)*this.zoom+this.viewportH/2}}screenToWorld(t,e){return{x:(t-this.viewportW/2)/this.zoom+this.x,y:(e-this.viewportH/2)/this.zoom+this.y}}adjustZoom(t){const e=Math.max(c.CAMERA_ZOOM_MIN,Math.min(c.CAMERA_ZOOM_MAX,this.zoom+t));this.zoom=e,this.targetZoom=e}}const es=c.TILE_WIDTH,he=c.TILE_HEIGHT;function R(a,t){return{x:(a-t)*(es/2),y:(a+t)*(he/2)}}function Tt(a,t,e=0){return(a+t)*he+e}class ss{constructor(){this.snowflakes=[],this.inited=!1,this.sprites=[],this.bounds={minWx:0,maxWx:0,minWy:0,maxWy:0},this.opacity=1}init(t,e){const s=c.SNOW_PARTICLE_COUNT,i=c.SNOW_DEPTH_LAYERS,o=c.SNOW_MIN_SIZE,n=c.SNOW_MAX_SIZE,r=c.SNOW_OPACITY,l=c.SNOW_MAX_HEIGHT,h=c.SNOW_SPAWN_PADDING,d=R(-h,-h),u=R(t+h,-h),g=R(t+h,e+h),y=R(-h,e+h),f=this.bounds;f.minWx=y.x,f.maxWx=u.x,f.minWy=d.y,f.maxWy=g.y,this.snowflakes.length=0;for(let m=0;m<s;m++){const I=m%i/(i-1),_=o+(n-o)*I,p=.4+.6*I,T=r*(.3+.7*I);this.snowflakes.push({wx:f.minWx+Math.random()*(f.maxWx-f.minWx),wy:f.minWy+Math.random()*(f.maxWy-f.minWy),z:Math.random()*l,radius:_,speed:p,opacity:T,phase:Math.random()*Math.PI*2})}this.sprites.length=0;for(let m=0;m<i;m++){const v=m/(i-1),I=o+(n-o)*v,_=r*(.3+.7*v),p=Math.ceil(I*2)+2,T=document.createElement("canvas");T.width=p,T.height=p;const w=T.getContext("2d"),S=p/2,E=w.createRadialGradient(S,S,0,S,S,I);E.addColorStop(0,`rgba(255,255,255,${_})`),E.addColorStop(.5,`rgba(230,235,255,${_*.5})`),E.addColorStop(1,"rgba(200,210,230,0)"),w.fillStyle=E,w.beginPath(),w.arc(S,S,I,0,Math.PI*2),w.fill(),this.sprites.push(T)}this.inited=!0}draw(t,e,s,i,o,n,r,l){if(this.opacity<.001)return;this.inited||this.init(o,n);const h=c.SNOW_DEPTH_LAYERS,d=c.SNOW_FALL_SPEED,u=c.SNOW_WIND_SPEED,g=c.SNOW_WOBBLE_SPEED,y=c.SNOW_WOBBLE_AMP,f=c.SNOW_MAX_HEIGHT,m=this.bounds,v=m.maxWx-m.minWx,I=m.maxWy-m.minWy;t.save(),t.globalAlpha=this.opacity;for(const _ of this.snowflakes){_.z-=d*_.speed*r,_.wx+=u*_.speed*r,_.wx+=Math.sin(l*g+_.phase)*y*_.speed*r,_.z<=0&&(_.z=f+Math.random()*50,_.wx=m.minWx+Math.random()*v,_.wy=m.minWy+Math.random()*I),_.wx>m.maxWx?_.wx-=v:_.wx<m.minWx&&(_.wx+=v);const p=e.worldToScreen(_.wx,_.wy-_.z);if(p.x<-10||p.x>s+10||p.y<-10||p.y>i+10)continue;const T=Math.round((_.radius-c.SNOW_MIN_SIZE)/(c.SNOW_MAX_SIZE-c.SNOW_MIN_SIZE)*(h-1)),w=this.sprites[Math.min(T,this.sprites.length-1)];w&&t.drawImage(w,p.x-w.width/2,p.y-w.height/2)}t.restore()}}function is(a,t,e){const s=i=>Math.round(Math.max(0,Math.min(1,i))*255).toString(16).padStart(2,"0");return"#"+s(a)+s(t)+s(e)}class os{constructor(){this.vignetteColor="#060812",this.vignetteOpacity=1,this.wispR255=6,this.wispG255=8,this.wispB255=18,this.wispOpacity=1,this.wispAdditive=!0}applyVignetteProfile(t,e,s,i){this.vignetteColor=is(t,e,s),this.vignetteOpacity=i}applyWispProfile(t,e,s,i,o){this.wispR255=Math.round(t*255),this.wispG255=Math.round(e*255),this.wispB255=Math.round(s*255),this.wispOpacity=i,this.wispAdditive=o}drawBoundaryVignette(t,e,s,i,o,n,r="all"){if(this.vignetteOpacity<.001)return;const l=s,h=i,d=R(0,0),u=R(o,0),g=R(o,n),y=R(0,n),f=e.worldToScreen(d.x,d.y),m=e.worldToScreen(u.x,u.y),v=e.worldToScreen(g.x,g.y),I=e.worldToScreen(y.x,y.y),_=c.BOUNDARY_FOG_PADDING,p={x:f.x,y:f.y+_},T={x:v.x,y:v.y-_},w={x:I.x+_,y:I.y},S={x:m.x-_,y:m.y},E=400,O=this.vignetteColor,H=this.vignetteOpacity;t.save(),t.globalCompositeOperation="source-over";const D=c.BOUNDARY_FOG_BACK_MULT;if(r==="back"||r==="all"){const q=(w.x+S.x)/2,x=(p.y+T.y)/2,A=Math.abs(S.x-w.x)/2,P=Math.abs(T.y-p.y)/2,L=Math.max(A,P,l,h);t.save(),t.globalAlpha=D*H,t.translate(q,x),t.scale(1,P/A||1);const N=t.createRadialGradient(0,0,A*.55,0,0,A*1.1);N.addColorStop(0,"transparent"),N.addColorStop(.5,"transparent"),N.addColorStop(.75,O+"80"),N.addColorStop(1,O),t.fillStyle=N,t.fillRect(-L,-L/(P/A||1),L*2,L*2/(P/A||1)),t.restore()}const $=r==="back"||r==="all",C=r==="back"||r==="all",X=r==="front"||r==="all",k=r==="front"||r==="all",j=[{size:E,opacity:.7},{size:E*.7,opacity:.5}];for(const q of j){const x=q.size;if($){const A=q.opacity*D*H,P=Math.round(A*255).toString(16).padStart(2,"0"),L=p.y,N=t.createLinearGradient(0,L-x,0,L+x);N.addColorStop(0,O+P),N.addColorStop(.4,O+P),N.addColorStop(1,"transparent"),t.fillStyle=N,t.fillRect(0,0,l,L+x)}if(X){const A=Math.round(q.opacity*H*255).toString(16).padStart(2,"0"),P=T.y,L=t.createLinearGradient(0,P-x,0,P+x);L.addColorStop(0,"transparent"),L.addColorStop(.6,O+A),L.addColorStop(1,O+A),t.fillStyle=L,t.fillRect(0,P-x,l,h-P+x*2)}if(C){const A=q.opacity*D*H,P=Math.round(A*255).toString(16).padStart(2,"0"),L=w.x,N=t.createLinearGradient(L-x,0,L+x,0);N.addColorStop(0,O+P),N.addColorStop(.4,O+P),N.addColorStop(1,"transparent"),t.fillStyle=N,t.fillRect(0,0,L+x,h)}if(k){const A=Math.round(q.opacity*H*255).toString(16).padStart(2,"0"),P=S.x,L=t.createLinearGradient(P-x,0,P+x,0);L.addColorStop(0,"transparent"),L.addColorStop(.6,O+A),L.addColorStop(1,O+A),t.fillStyle=L,t.fillRect(P-x,0,l-P+x*2,h)}}t.restore()}drawAnimatedEdgeFog(t,e,s,i,o,n="all"){if(this.wispOpacity<.001)return;const r=R(0,0),l=R(s,0),h=R(s,i),d=R(0,i),u=e.worldToScreen(r.x,r.y),g=e.worldToScreen(l.x,l.y),y=e.worldToScreen(h.x,h.y),f=e.worldToScreen(d.x,d.y),m=c.BOUNDARY_FOG_PADDING,v={x:u.x,y:u.y+m},I={x:g.x-m,y:g.y},_={x:y.x,y:y.y-m},p={x:f.x+m,y:f.y},T=(p.x+I.x)/2,w=(v.y+_.y)/2,S=[{sx:v.x,sy:v.y,ex:I.x,ey:I.y},{sx:I.x,sy:I.y,ex:_.x,ey:_.y},{sx:_.x,sy:_.y,ex:p.x,ey:p.y},{sx:p.x,sy:p.y,ex:v.x,ey:v.y}];let E;n==="back"?E=[0,3]:n==="front"?E=[1,2]:E=[0,1,2,3];const O=c.FOG_WISPS_PER_EDGE,H=c.FOG_WISP_SIZE,D=c.FOG_WISP_OPACITY*this.wispOpacity,$=c.BOUNDARY_FOG_BACK_MULT,C=c.FOG_WISP_DRIFT_SPEED,X=c.FOG_WISP_BREATH_SPEED,k=c.FOG_WISP_REACH,j=new Set([0,3]),q=this.wispR255,x=this.wispG255,A=this.wispB255,P=this.wispAdditive?Math.min(255,q+110):q,L=this.wispAdditive?Math.min(255,x+130):x,N=this.wispAdditive?Math.min(255,A+140):A,_e=this.wispAdditive?Math.min(255,q+70):Math.max(0,q-15),ve=this.wispAdditive?Math.min(255,x+90):Math.max(0,x-15),Ie=this.wispAdditive?Math.min(255,A+100):Math.max(0,A-15),we=this.wispAdditive?Math.min(255,q+35):Math.max(0,q-30),be=this.wispAdditive?Math.min(255,x+45):Math.max(0,x-30),Se=this.wispAdditive?Math.min(255,A+55):Math.max(0,A-30);t.save(),t.globalCompositeOperation=this.wispAdditive?"lighter":"source-over";for(const wt of E){const Z=S[wt],ct=Z.ex-Z.sx,ht=Z.ey-Z.sy,Wt=Math.sqrt(ct*ct+ht*ht),Nt=ct/Wt,Ft=ht/Wt;for(let dt=0;dt<O;dt++){const ut=(wt*O+dt)*2.399,Ut=(dt+.5)/O,Bt=Z.sx+ct*Ut,qt=Z.sy+ht*Ut,jt=Math.sin(o*C+ut)*50,bt=T-Bt,St=w-qt,$t=Math.sqrt(bt*bt+St*St)||1,Yt=Math.sin(o*C*.7+ut*2.1)*k,Te=Bt+Nt*jt+bt/$t*Yt,Re=qt+Ft*jt+St/$t*Yt,Ee=.5+.5*Math.sin(o*X+ut*3.7),Me=j.has(wt)?$:1,Vt=D*Me*(.3+.7*Ee),Xt=H*(.7+.3*Math.sin(ut*5.3));t.save(),t.translate(Te,Re);const xe=Math.atan2(Ft,Nt);t.rotate(xe),t.scale(1.6,1);const ft=t.createRadialGradient(0,0,0,0,0,Xt);ft.addColorStop(0,`rgba(${P},${L},${N},${Vt})`),ft.addColorStop(.4,`rgba(${_e},${ve},${Ie},${Vt*.5})`),ft.addColorStop(1,`rgba(${we},${be},${Se},0)`),t.fillStyle=ft,t.beginPath(),t.arc(0,0,Xt,0,Math.PI*2),t.fill(),t.restore()}}t.restore()}}var st=(a=>(a[a.GROUND=0]="GROUND",a[a.OBJECT=1]="OBJECT",a))(st||{});class ns{constructor(t,e){this.renderQueue=[],this.snowfallEffect=new ss,this.fogEffect=new os,this.bgColor="#060812",this.camera=e,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),t.appendChild(this.canvas),this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.canvas.style.width=window.innerWidth+"px",this.canvas.style.height=window.innerHeight+"px",this.camera.setViewport(this.canvas.width,this.canvas.height),this.ctx.imageSmoothingEnabled=!1}setBackgroundColor(t){this.bgColor=t}clear(){this.ctx.fillStyle=this.bgColor,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.renderQueue.length=0}enqueueTile(t,e,s,i,o,n,r){const l=R(t,e);this.renderQueue.push({layer:0,screenX:l.x,screenY:l.y,depth:Tt(t,e,0),assetId:s,srcX:0,srcY:0,srcW:i,srcH:o,offsetX:-n/2,offsetY:0,drawW:n,drawH:r,opacity:1,rotation:0})}enqueueEntity(t){const e=t.animController;if(!e)return;const s=t.transform,i=R(s.x,s.y),o=e.getCurrentFrame(),n=e.getCurrentAssetId(),r=t.drawScale,l=o.width*r,h=o.height*r;this.renderQueue.push({layer:1,screenX:i.x,screenY:i.y,depth:Tt(s.x,s.y,0),assetId:n,srcX:o.x,srcY:o.y,srcW:o.width,srcH:o.height,offsetX:-l/2,offsetY:-h+c.TILE_HEIGHT/2-s.z,drawW:l,drawH:h,opacity:t.opacity,rotation:0})}enqueueObject(t,e,s,i,o,n=.9,r,l,h=1,d=0,u=0){const g=R(t,e),y=h===0?o*(1-n)/c.TILE_HEIGHT:0;this.renderQueue.push({layer:h,screenX:g.x,screenY:g.y,depth:Tt(t,e+y,0)+.01+u,assetId:s,srcX:0,srcY:0,srcW:r??i,srcH:l??o,offsetX:-i/2,offsetY:-o*n+c.TILE_HEIGHT/2,drawW:i,drawH:o,opacity:1,rotation:d})}enqueueCustomDraw(t,e,s){this.renderQueue.push({layer:t,depth:e,drawFn:s,screenX:0,screenY:0,assetId:"",srcX:0,srcY:0,srcW:0,srcH:0,offsetX:0,offsetY:0,drawW:0,drawH:0,opacity:1,rotation:0})}flushLayer(t){this.renderQueue.sort((i,o)=>i.layer-o.layer||i.depth-o.depth);const e=this.camera,s=e.zoom;for(const i of this.renderQueue){if(i.layer!==t)continue;if(i.drawFn){i.drawFn(this.ctx);continue}const o=b.get(i.assetId);if(!o)continue;const n=e.worldToScreen(i.screenX,i.screenY),r=n.x+i.offsetX*s,l=n.y+i.offsetY*s,h=i.drawW*s,d=i.drawH*s;if(!(r+h<0||r>this.canvas.width)&&!(l+d<0||l>this.canvas.height)){if(i.opacity<1&&(this.ctx.globalAlpha=i.opacity),i.rotation!==0){const u=r+h/2,g=l+d/2;this.ctx.save(),this.ctx.translate(u,g),this.ctx.rotate(i.rotation),this.ctx.drawImage(o,i.srcX,i.srcY,i.srcW,i.srcH,-h/2,-d/2,h,d),this.ctx.restore()}else this.ctx.drawImage(o,i.srcX,i.srcY,i.srcW,i.srcH,r,l,h,d);i.opacity<1&&(this.ctx.globalAlpha=1)}}}drawBlobShadow(t,e,s,i,o){const n=this.camera,r=n.zoom,l=n.worldToScreen(t,e),h=s*r,d=i*r,u=this.ctx;u.save(),u.translate(l.x,l.y+c.TILE_HEIGHT/2*r),u.scale(1,d/h);const g=u.createRadialGradient(0,0,0,0,0,h);g.addColorStop(0,`rgba(0,0,0,${o})`),g.addColorStop(.55,`rgba(0,0,0,${o*.6})`),g.addColorStop(1,"rgba(0,0,0,0)"),u.fillStyle=g,u.beginPath(),u.arc(0,0,h,0,Math.PI*2),u.fill(),u.restore()}drawGlow(t,e,s,i,o,n,r,l){const h=this.camera,d=h.zoom,u=h.worldToScreen(t,e),g=i*d,y=u.y+(c.TILE_HEIGHT/2-s)*d,f=this.ctx;f.save(),f.globalCompositeOperation="lighter";const m=f.createRadialGradient(u.x,y,0,u.x,y,g);m.addColorStop(0,`rgba(${o},${n},${r},${l})`),m.addColorStop(.4,`rgba(${o},${n},${r},${l*.5})`),m.addColorStop(1,`rgba(${o},${n},${r},0)`),f.fillStyle=m,f.beginPath(),f.arc(u.x,y,g,0,Math.PI*2),f.fill(),f.restore()}applyEffectProfile(t){this.fogEffect.applyVignetteProfile(t.vignetteR,t.vignetteG,t.vignetteB,t.vignetteOpacity),this.fogEffect.applyWispProfile(t.fogWispR,t.fogWispG,t.fogWispB,t.fogWispOpacity,t.fogWispAdditive),this.snowfallEffect.opacity=t.snowOpacity}drawBoundaryVignette(t,e,s="all"){this.fogEffect.drawBoundaryVignette(this.ctx,this.camera,this.canvas.width,this.canvas.height,t,e,s)}drawAnimatedEdgeFog(t,e,s,i="all"){this.fogEffect.drawAnimatedEdgeFog(this.ctx,this.camera,t,e,s,i)}drawSnow(t,e,s,i){this.snowfallEffect.draw(this.ctx,this.camera,this.canvas.width,this.canvas.height,t,e,s,i)}drawGridOverlay(t,e){const s=this.camera;s.zoom,this.ctx.strokeStyle="rgba(255,255,255,0.08)",this.ctx.lineWidth=1;for(let i=0;i<=t;i++)for(let o=0;o<=e;o++){const n=R(i,o);if(s.worldToScreen(n.x,n.y),i<t&&o<e){const r=s.worldToScreen(n.x,n.y),l=s.worldToScreen(n.x+c.TILE_WIDTH/2,n.y+c.TILE_HEIGHT/2),h=s.worldToScreen(n.x,n.y+c.TILE_HEIGHT),d=s.worldToScreen(n.x-c.TILE_WIDTH/2,n.y+c.TILE_HEIGHT/2);this.ctx.beginPath(),this.ctx.moveTo(r.x,r.y),this.ctx.lineTo(l.x,l.y),this.ctx.lineTo(h.x,h.y),this.ctx.lineTo(d.x,d.y),this.ctx.closePath(),this.ctx.stroke()}}}}const Kt=16,Zt=32,Qt=8,as=`#version 300 es
in vec2 a_position;
in vec2 a_uv;
out vec2 v_uv;

void main() {
    v_uv = a_uv;
    gl_Position = vec4(a_position, 0.0, 1.0);
}`,rs=`#version 300 es
precision highp float;

#define MAX_LIGHTS    16
#define MAX_OCCLUDERS 32
#define MAX_HF        8

uniform sampler2D u_scene;
uniform vec2      u_resolution;
uniform vec3      u_ambientColor;
uniform float     u_time;
uniform float     u_isoRatio;   /* tile width / tile height (2.0 for standard 2:1 iso) */

/* Lights */
uniform int   u_numLights;
uniform vec2  u_lightPos      [MAX_LIGHTS];
uniform vec3  u_lightColor    [MAX_LIGHTS];
uniform float u_lightRadius   [MAX_LIGHTS];
uniform float u_lightIntensity[MAX_LIGHTS];
uniform float u_lightFlicker  [MAX_LIGHTS];

/* Occluders (shadow casters) */
uniform int   u_numOccluders;
uniform vec2  u_occPos   [MAX_OCCLUDERS];
uniform float u_occRadius[MAX_OCCLUDERS];
uniform float u_occHeight[MAX_OCCLUDERS];

/* Shadow controls */
uniform float u_shadowLenMult;
uniform float u_shadowOpacity;  /* 0 = no shadows, 1 = fully opaque */

/* Height-fade zones — reduces shadow on tall entities (feet=full shadow, head=lit) */
uniform int   u_numHF;                  /* number of active height-fade zones */
uniform vec2  u_hfFootPos [MAX_HF];     /* foot center in GL screen coords */
uniform float u_hfWidth   [MAX_HF];     /* sprite width in pixels */
uniform float u_hfHeight  [MAX_HF];     /* sprite height in pixels */
uniform float u_hfStrength[MAX_HF];     /* 0-1: how much shadow is reduced at head */
uniform int   u_hfSpriteOnly[MAX_HF];  /* 1 = use sprite-alpha only, skip rect fallback */

/* Volumetric sprite shading — cylindrical diffuse + rim light */
uniform sampler2D u_spriteTex;
uniform int       u_volActive;      /* 0 = off, 1 = on */
uniform vec4      u_spriteRect;     /* screen rect in GL pixels: x, y (bottom-left), w, h */
uniform vec4      u_spriteSrcUV;    /* source UV in sprite texture: u, v, uWidth, vHeight */
uniform float     u_volDiffuse;     /* cylindrical diffuse strength 0-1 */
uniform float     u_volRim;         /* rim light strength 0-1 */
uniform vec3      u_volRimColor;    /* rim light colour */

in  vec2 v_uv;
out vec4 fragColor;

/* ── helpers ──────────────────────────────────────────────────────── */

float hash(float n) {
    return fract(sin(n) * 43758.5453123);
}

/* Sample sprite alpha — returns 0.0 for UVs outside the source frame rect
   (prevents reading adjacent sprite-sheet frames during edge detection). */
float spriteAlpha(vec2 uv) {
    vec2 mn = u_spriteSrcUV.xy;
    vec2 mx = mn + u_spriteSrcUV.zw;
    if (uv.x < mn.x || uv.x > mx.x || uv.y < mn.y || uv.y > mx.y) return 0.0;
    return texture(u_spriteTex, uv).a;
}

/*
 * Soft shadow test: how much of 'light' reaches 'frag' given one occluder.
 * Returns 1.0 = fully lit, 0.0 = fully shadowed.
 *
 * Closest point on frag→light segment to occluder center, with smooth
 * boundary fades to avoid hard edges at segment endpoints.
 */
float shadowFactor(vec2 frag, vec2 light, vec2 occ, float r, float maxReach) {
    vec2  d   = light - frag;
    float len = length(d);
    if (len < 0.001) return 1.0;

    vec2  dir = d / len;
    float t   = dot(occ - frag, dir);

    /* Closest point on segment (clamped) */
    vec2  closest  = frag + dir * clamp(t, 0.0, len);
    float perpDist = distance(closest, occ);

    /* Perpendicular penumbra */
    float shadow = smoothstep(r * 0.3, r * 2.0, perpDist);

    /* Smooth boundary fade — replaces the hard t < 0 / t > len cutoff.
       Fades shadow in/out over a distance of r around each endpoint. */
    float fade = smoothstep(-r, r * 0.3, t)
               * smoothstep(len + r, len - r * 0.3, t);

    /* Limit shadow reach — distance from occluder fades shadow proportional to height */
    float distFromOcc = distance(frag, occ);
    float reachFade = 1.0 - smoothstep(maxReach * 0.5, maxReach, distFromOcc);

    return mix(1.0, shadow, fade * reachFade);
}

/* ── main ─────────────────────────────────────────────────────────── */

void main() {
    vec4 scene   = texture(u_scene, v_uv);
    vec2 fragPos = v_uv * u_resolution;

    /* Ambient is non-directional — kept separate so volumetric diffuse
       doesn't darken it (ambient wraps around uniformly). */
    vec3 ambient = u_ambientColor;
    vec3 direct  = vec3(0.0);          /* directional / point-light accumulator */

    /* accumulate point lights */
    for (int i = 0; i < MAX_LIGHTS; i++) {
        if (i >= u_numLights) break;

        /* Isometric elliptical distance — stretch Y by isoRatio so the light
           pool matches the ground plane (wider horizontally, compressed vertically). */
        vec2 delta    = fragPos - u_lightPos[i];
        delta.y      *= u_isoRatio;
        float dist    = length(delta);
        float normDist = clamp(dist / (u_lightRadius[i] * u_isoRatio), 0.0, 1.0);

        /* smooth quadratic falloff (gentle, wide glow) */
        float atten = 1.0 - normDist * normDist;

        /* optional flicker */
        float flicker = 1.0;
        if (u_lightFlicker[i] > 0.0) {
            float n = hash(floor(u_time * 8.0) + float(i) * 13.7);
            flicker = 1.0 - u_lightFlicker[i] * n * 0.5;
        }

        /* combined shadow from all occluders for this light.
           Use min (not multiply) — opaque objects don't stack shadows. */
        float shadow = 1.0;
        for (int j = 0; j < MAX_OCCLUDERS; j++) {
            if (j >= u_numOccluders) break;
            float maxReach = u_occHeight[j] * u_shadowLenMult;
            shadow = min(shadow, shadowFactor(fragPos, u_lightPos[i], u_occPos[j], u_occRadius[j], maxReach));
        }

        /* Height fade: tall entities see over ground-level shadows.
           Each registered height-fade zone lifts shadow from feet→head
           so the entity doesn't go uniformly dark.

           For the zone that overlaps the volumetric sprite, we use
           actual sprite alpha for precise masking.  All others use a
           soft rectangular containment fallback. */
        for (int k = 0; k < MAX_HF; k++) {
            if (k >= u_numHF) break;

            float hfMask = 0.0;

            /* Try precise sprite-alpha path (only hits pixels on the
               volumetric sprite — automatically skips other entities). */
            if (u_volActive > 0) {
                vec2 sprMin  = u_spriteRect.xy;
                vec2 sprSize = u_spriteRect.zw;
                vec2 lp = fragPos - sprMin;
                if (lp.x >= 0.0 && lp.x <= sprSize.x &&
                    lp.y >= 0.0 && lp.y <= sprSize.y) {
                    vec2 luv   = lp / sprSize;
                    vec2 srcUV = u_spriteSrcUV.xy + luv * u_spriteSrcUV.zw;
                    hfMask = spriteAlpha(srcUV);
                }
            }

            /* Fallback: soft rectangular containment (skip for sprite-alpha-only zones) */
            if (hfMask < 0.01 && u_hfSpriteOnly[k] == 0) {
                float dxx = abs(fragPos.x - u_hfFootPos[k].x);
                hfMask = 1.0 - smoothstep(u_hfWidth[k] * 0.1, u_hfWidth[k] * 1.0, dxx);
            }

            if (hfMask > 0.1) {
                float dyy = fragPos.y - u_hfFootPos[k].y;
                float hy = smoothstep(0.0, u_hfHeight[k] * 1.0, dyy)
                         * (1.0 - smoothstep(u_hfHeight[k] * 0.8, u_hfHeight[k] * 0.9, dyy));

                vec2  hlDir = u_lightPos[i] - vec2(u_hfFootPos[k].x, u_hfFootPos[k].y + u_hfHeight[k] * 0.5);
                float isoZ  = -hlDir.y + abs(hlDir.x) * 0.3;
                float frontFac = smoothstep(-80.0, 80.0, isoZ);

                shadow = mix(shadow, 1.0, hfMask * hy * u_hfStrength[k] * frontFac);
            }
        }

        /* Apply shadow opacity — blend shadow toward 1.0 (no shadow) */
        shadow = mix(1.0, shadow, u_shadowOpacity);

        direct += u_lightColor[i] * u_lightIntensity[i] * atten * flicker * shadow;
    }

    /* ── Volumetric sprite shading ── cylindrical diffuse + rim light ── */
    /* IMPORTANT: diffuse only modulates the directional accumulator.
       Ambient is non-directional and should not be darkened by the cylinder. */
    if (u_volActive > 0 && u_numLights > 0) {
        vec2 sprMin  = u_spriteRect.xy;
        vec2 sprSize = u_spriteRect.zw;
        vec2 lp = fragPos - sprMin;

        if (lp.x >= 0.0 && lp.x <= sprSize.x && lp.y >= 0.0 && lp.y <= sprSize.y) {
            vec2 luv   = lp / sprSize;
            vec2 srcUV = u_spriteSrcUV.xy + luv * u_spriteSrcUV.zw;
            float alpha = spriteAlpha(srcUV);

            if (alpha > 0.1) {
                /* Cylindrical normal — character is a vertical cylinder */
                float nx = (luv.x - 0.5) * 2.0;
                float nz = sqrt(max(0.001, 1.0 - nx * nx));
                vec3 N = normalize(vec3(nx, 0.0, nz));

                /* 3D light direction from sky light (index 0).
                   In isometric, higher GL Y = farther from camera = "behind".
                   Infer Z from the Y component: light below sprite → Z positive
                   (in front), light above → Z negative (behind).
                   The X component adds a side-light bias so horizontal
                   lights don't collapse to Z=0. */
                vec2  toLight  = u_lightPos[0] - fragPos;
                float isoLZ   = -toLight.y + abs(toLight.x) * 0.3;
                /* Minimum magnitude prevents degenerate normalisation */
                isoLZ = sign(isoLZ) * max(abs(isoLZ), 50.0);
                vec3  L        = normalize(vec3(toLight, isoLZ));
                float NdotL    = dot(N, L);

                /* Half-Lambert diffuse — applied ONLY to directional light */
                float diffuse = NdotL * 0.5 + 0.5;
                direct *= mix(vec3(1.0), vec3(diffuse), u_volDiffuse);

                /* Rim light via alpha-edge detection.
                   Sample alpha at ±1.5 px in each direction;
                   edge pixels have at least one transparent neighbour. */
                vec2  pxUV = u_spriteSrcUV.zw / sprSize;  /* 1 screen-pixel in UV */
                float sD   = 1.5;
                float aL = spriteAlpha(srcUV + vec2(-pxUV.x * sD, 0.0));
                float aR = spriteAlpha(srcUV + vec2( pxUV.x * sD, 0.0));
                float aU = spriteAlpha(srcUV + vec2(0.0,  pxUV.y * sD));
                float aD = spriteAlpha(srcUV + vec2(0.0, -pxUV.y * sD));

                float edge = 1.0 - min(min(aL, aR), min(aU, aD));
                edge *= smoothstep(0.1, 0.5, alpha);   /* fade with sprite alpha */

                /* Fresnel-like: brighter on the side facing away from light */
                float rim = pow(1.0 - clamp(NdotL, 0.0, 1.0), 2.0)
                          * edge * u_volRim;
                direct += u_volRimColor * rim;
            }
        }
    }

    /* Combine ambient + directional, clamp to allow slight bloom from rim */
    vec3 light = min(ambient + direct, vec3(1.2));
    fragColor = vec4(scene.rgb * light, 1.0);
}`;class ls{constructor(t,e){this.gl=null,this.program=null,this.sceneTex=null,this.vao=null,this.loc={},this.lights=[],this.occluders=[],this.ambientR=.15,this.ambientG=.12,this.ambientB=.2,this.time=0,this.shadowLenMult=2,this.shadowOpacity=1,this._enabled=!0,this.hfZones=[],this.spriteTex=null,this.volActive=!1,this.spriteScreenX=0,this.spriteScreenY=0,this.spriteScreenW=0,this.spriteScreenH=0,this.spriteSrcU=0,this.spriteSrcV=0,this.spriteSrcUW=1,this.spriteSrcVH=1,this.volDiffuse=.45,this.volRim=.6,this.volRimR=.6,this.volRimG=.75,this.volRimB=1,this.spriteImage=null,this.sourceCanvas=e,this.glCanvas=document.createElement("canvas"),Object.assign(this.glCanvas.style,{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none",zIndex:"1",imageRendering:"pixelated"}),t.appendChild(this.glCanvas);const s=this.glCanvas.getContext("webgl2",{alpha:!1,premultipliedAlpha:!1,antialias:!1});if(!s){console.warn("[PostProcess] WebGL2 unavailable — lighting disabled."),this._enabled=!1,this.glCanvas.style.display="none";return}this.gl=s,this.initShaders(),this.initGeometry(),this.initTexture(),this.resize(),window.addEventListener("resize",()=>this.resize())}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this.glCanvas.style.display=t?"block":"none"}compileShader(t,e){const s=this.gl,i=s.createShader(t);return s.shaderSource(i,e),s.compileShader(i),s.getShaderParameter(i,s.COMPILE_STATUS)?i:(console.error("[PostProcess] Shader error:",s.getShaderInfoLog(i)),s.deleteShader(i),null)}initShaders(){const t=this.gl,e=this.compileShader(t.VERTEX_SHADER,as),s=this.compileShader(t.FRAGMENT_SHADER,rs);if(!e||!s)return;const i=t.createProgram();if(t.attachShader(i,e),t.attachShader(i,s),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS)){console.error("[PostProcess] Link error:",t.getProgramInfoLog(i));return}this.program=i,t.useProgram(i);for(const o of["u_scene","u_resolution","u_ambientColor","u_time","u_isoRatio","u_numLights","u_numOccluders","u_shadowLenMult","u_shadowOpacity","u_numHF","u_spriteTex","u_volActive","u_spriteRect","u_spriteSrcUV","u_volDiffuse","u_volRim","u_volRimColor"])this.loc[o]=t.getUniformLocation(i,o);for(let o=0;o<Kt;o++)for(const n of["u_lightPos","u_lightColor","u_lightRadius","u_lightIntensity","u_lightFlicker"])this.loc[`${n}[${o}]`]=t.getUniformLocation(i,`${n}[${o}]`);for(let o=0;o<Zt;o++)this.loc[`u_occPos[${o}]`]=t.getUniformLocation(i,`u_occPos[${o}]`),this.loc[`u_occRadius[${o}]`]=t.getUniformLocation(i,`u_occRadius[${o}]`),this.loc[`u_occHeight[${o}]`]=t.getUniformLocation(i,`u_occHeight[${o}]`);for(let o=0;o<Qt;o++)this.loc[`u_hfFootPos[${o}]`]=t.getUniformLocation(i,`u_hfFootPos[${o}]`),this.loc[`u_hfWidth[${o}]`]=t.getUniformLocation(i,`u_hfWidth[${o}]`),this.loc[`u_hfHeight[${o}]`]=t.getUniformLocation(i,`u_hfHeight[${o}]`),this.loc[`u_hfStrength[${o}]`]=t.getUniformLocation(i,`u_hfStrength[${o}]`),this.loc[`u_hfSpriteOnly[${o}]`]=t.getUniformLocation(i,`u_hfSpriteOnly[${o}]`)}initGeometry(){const t=this.gl,e=new Float32Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]);this.vao=t.createVertexArray(),t.bindVertexArray(this.vao);const s=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW);const i=t.getAttribLocation(this.program,"a_position");t.enableVertexAttribArray(i),t.vertexAttribPointer(i,2,t.FLOAT,!1,16,0);const o=t.getAttribLocation(this.program,"a_uv");t.enableVertexAttribArray(o),t.vertexAttribPointer(o,2,t.FLOAT,!1,16,8),t.bindVertexArray(null)}initTexture(){const t=this.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,1),this.sceneTex=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.sceneTex),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),this.spriteTex=t.createTexture(),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,this.spriteTex),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.activeTexture(t.TEXTURE0)}resize(){this.glCanvas.width=window.innerWidth,this.glCanvas.height=window.innerHeight,this.gl?.viewport(0,0,this.glCanvas.width,this.glCanvas.height)}setAmbient(t,e,s){this.ambientR=t,this.ambientG=e,this.ambientB=s}clearLights(){this.lights.length=0}addLight(t){this.lights.length<Kt&&this.lights.push(t)}setShadowLengthMult(t){this.shadowLenMult=t}setShadowOpacity(t){this.shadowOpacity=t}clearOccluders(){this.occluders.length=0}addOccluder(t){this.occluders.length<Zt&&this.occluders.push(t)}addHeightFade(t,e,s,i,o,n=!1){this.hfZones.length<Qt&&this.hfZones.push({footX:t,footY:e,width:s,height:i,strength:o,spriteOnly:n})}clearHeightFade(){this.hfZones.length=0}setVolumetricSprite(t,e,s,i,o,n,r,l,h){this.volActive=!0,this.spriteImage=t,this.spriteScreenX=e,this.spriteScreenY=s,this.spriteScreenW=i,this.spriteScreenH=o,this.spriteSrcU=n,this.spriteSrcV=r,this.spriteSrcUW=l,this.spriteSrcVH=h}setVolumetricParams(t,e,s,i,o){this.volDiffuse=t,this.volRim=e,this.volRimR=s,this.volRimG=i,this.volRimB=o}clearVolumetric(){this.volActive=!1,this.spriteImage=null}render(t){if(!this._enabled||!this.gl||!this.program)return;const e=this.gl;this.time+=t,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.sceneTex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.sourceCanvas),e.useProgram(this.program),e.uniform1i(this.loc.u_scene,0),e.uniform2f(this.loc.u_resolution,this.glCanvas.width,this.glCanvas.height),e.uniform3f(this.loc.u_ambientColor,this.ambientR,this.ambientG,this.ambientB),e.uniform1f(this.loc.u_time,this.time),e.uniform1f(this.loc.u_isoRatio,c.TILE_WIDTH/c.TILE_HEIGHT),e.uniform1i(this.loc.u_numLights,this.lights.length),e.uniform1i(this.loc.u_numOccluders,this.occluders.length),e.uniform1f(this.loc.u_shadowLenMult,this.shadowLenMult),e.uniform1f(this.loc.u_shadowOpacity,this.shadowOpacity);const s=this.glCanvas.height;for(let i=0;i<this.lights.length;i++){const o=this.lights[i];e.uniform2f(this.loc[`u_lightPos[${i}]`],o.x,s-o.y),e.uniform3f(this.loc[`u_lightColor[${i}]`],o.r,o.g,o.b),e.uniform1f(this.loc[`u_lightRadius[${i}]`],o.radius),e.uniform1f(this.loc[`u_lightIntensity[${i}]`],o.intensity),e.uniform1f(this.loc[`u_lightFlicker[${i}]`],o.flicker)}for(let i=0;i<this.occluders.length;i++){const o=this.occluders[i];e.uniform2f(this.loc[`u_occPos[${i}]`],o.x,s-o.y),e.uniform1f(this.loc[`u_occRadius[${i}]`],o.radius),e.uniform1f(this.loc[`u_occHeight[${i}]`],o.height)}e.uniform1i(this.loc.u_numHF,this.hfZones.length);for(let i=0;i<this.hfZones.length;i++){const o=this.hfZones[i];e.uniform2f(this.loc[`u_hfFootPos[${i}]`],o.footX,s-o.footY),e.uniform1f(this.loc[`u_hfWidth[${i}]`],o.width),e.uniform1f(this.loc[`u_hfHeight[${i}]`],o.height),e.uniform1f(this.loc[`u_hfStrength[${i}]`],o.strength),e.uniform1i(this.loc[`u_hfSpriteOnly[${i}]`],o.spriteOnly?1:0)}if(e.uniform1i(this.loc.u_volActive,this.volActive?1:0),this.volActive&&this.spriteImage){e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.spriteTex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.spriteImage),e.uniform1i(this.loc.u_spriteTex,1);const i=this.spriteScreenX,o=s-this.spriteScreenY-this.spriteScreenH;e.uniform4f(this.loc.u_spriteRect,i,o,this.spriteScreenW,this.spriteScreenH),e.uniform4f(this.loc.u_spriteSrcUV,this.spriteSrcU,this.spriteSrcV,this.spriteSrcUW,this.spriteSrcVH),e.uniform1f(this.loc.u_volDiffuse,this.volDiffuse),e.uniform1f(this.loc.u_volRim,this.volRim),e.uniform3f(this.loc.u_volRimColor,this.volRimR,this.volRimG,this.volRimB),e.activeTexture(e.TEXTURE0)}e.bindVertexArray(this.vao),e.drawArrays(e.TRIANGLE_STRIP,0,4),e.bindVertexArray(null)}}var W=(a=>(a.MOVE_UP="MOVE_UP",a.MOVE_DOWN="MOVE_DOWN",a.MOVE_LEFT="MOVE_LEFT",a.MOVE_RIGHT="MOVE_RIGHT",a.RUN="RUN",a.INTERACT="INTERACT",a.TOGGLE_LIGHT="TOGGLE_LIGHT",a.TOGGLE_SNOW="TOGGLE_SNOW",a.TOGGLE_TIME="TOGGLE_TIME",a.INVENTORY="INVENTORY",a.QUEST_LOG="QUEST_LOG",a.DEBUG_GRID="DEBUG_GRID",a.PAUSE="PAUSE",a.CONTROLS_HELP="CONTROLS_HELP",a.TOGGLE_DEBUG="TOGGLE_DEBUG",a.TOGGLE_QUEST_HUD="TOGGLE_QUEST_HUD",a))(W||{});const cs={MOVE_UP:["KeyW","ArrowUp"],MOVE_DOWN:["KeyS","ArrowDown"],MOVE_LEFT:["KeyA","ArrowLeft"],MOVE_RIGHT:["KeyD","ArrowRight"],RUN:["ShiftLeft","ShiftRight"],INTERACT:["KeyE"],TOGGLE_LIGHT:["KeyL"],TOGGLE_SNOW:["KeyN"],TOGGLE_TIME:["KeyT"],INVENTORY:["KeyI"],QUEST_LOG:["KeyJ"],DEBUG_GRID:["KeyG"],PAUSE:["Escape"],CONTROLS_HELP:["KeyH"],TOGGLE_DEBUG:["KeyU"],TOGGLE_QUEST_HUD:["KeyQ"]};class hs{constructor(t){this.providers=t}isActionDown(t){for(const e of this.providers)if(e.isActionActive(t))return!0;return!1}consumeAction(t){let e=!1;for(const s of this.providers)s.consumeAction(t)&&(e=!0);return e}getMovementVector(){let t={x:0,y:0},e=0;for(const s of this.providers){const i=s.getMovementVector(),o=i.x*i.x+i.y*i.y;o>e&&(t=i,e=o)}return t}isRunning(){return this.isActionDown("RUN")}getMouseScreen(){for(const t of this.providers){const e=t.getPointerPosition();if(e.x!==0||e.y!==0)return e}return{x:0,y:0}}dispose(){for(const t of this.providers)t.dispose()}}class ds{constructor(t,e,s){this.canvas=t,this.camera=e,this.keys=new Set,this.justPressed=new Set,this.mouseX=0,this.mouseY=0,this.bindings={...cs,...s},this.abort=new AbortController;const i=this.abort.signal;window.addEventListener("keydown",o=>{o.repeat||this.justPressed.add(o.code),this.keys.add(o.code),["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Space"].includes(o.code)&&o.preventDefault()},{signal:i}),window.addEventListener("keyup",o=>{this.keys.delete(o.code)},{signal:i}),window.addEventListener("blur",()=>{this.keys.clear(),this.justPressed.clear()},{signal:i}),t.addEventListener("mousemove",o=>{this.mouseX=o.clientX,this.mouseY=o.clientY},{signal:i}),t.addEventListener("wheel",o=>{o.preventDefault();const n=o.deltaY<0?1:-1;this.camera.adjustZoom(n*c.CAMERA_ZOOM_STEP)},{passive:!1,signal:i})}isActionActive(t){const e=this.bindings[t];for(const s of e)if(this.keys.has(s))return!0;return!1}consumeAction(t){const e=this.bindings[t];for(const s of e)if(this.justPressed.has(s))return this.justPressed.delete(s),!0;return!1}getMovementVector(){let t=0,e=0;this.isActionActive(W.MOVE_UP)&&(e-=1),this.isActionActive(W.MOVE_DOWN)&&(e+=1),this.isActionActive(W.MOVE_LEFT)&&(t-=1),this.isActionActive(W.MOVE_RIGHT)&&(t+=1);const s=Math.sqrt(t*t+e*e);return s>0&&(t/=s,e/=s),{x:t,y:e}}getPointerPosition(){return{x:this.mouseX,y:this.mouseY}}rebind(t,e){this.bindings[t]=e}dispose(){this.abort.abort()}}const Rt=130,Jt=46,te=24,us=.6,fs=56,ee=16,ps=80;class gs{constructor(t){this.container=t,this.joyVec={x:0,y:0},this.joyRunning=!1,this.joyTouchId=null,this.joyCenterX=0,this.joyCenterY=0,this.activeActions=new Set,this.pendingActions=new Set,this.buttons=[],this.lastPointerX=0,this.lastPointerY=0,this.onTouchStart=s=>{for(let i=0;i<s.changedTouches.length;i++){const o=s.changedTouches[i];if(this.lastPointerX=o.clientX,this.lastPointerY=o.clientY,this.handleButtonTouchStart(o)){s.preventDefault();continue}if(this.joyTouchId===null&&o.clientX<window.innerWidth*.45){if(document.elementFromPoint(o.clientX,o.clientY)?.closest("#dialog-container, #inventory-container, #questlog-container, #note-container, #item-preview-container, #controls-help-container, #back-to-hub"))continue;this.joyTouchId=o.identifier;const l=this.joyBase.getBoundingClientRect();this.joyCenterX=l.left+l.width/2,this.joyCenterY=l.top+l.height/2,this.updateJoystick(o.clientX,o.clientY),s.preventDefault()}}},this.onTouchMove=s=>{for(let i=0;i<s.changedTouches.length;i++){const o=s.changedTouches[i];o.identifier===this.joyTouchId&&(this.updateJoystick(o.clientX,o.clientY),s.preventDefault()),this.lastPointerX=o.clientX,this.lastPointerY=o.clientY}},this.onTouchEnd=s=>{for(let i=0;i<s.changedTouches.length;i++){const o=s.changedTouches[i];o.identifier===this.joyTouchId&&this.resetJoystick(),this.handleButtonTouchEnd(o.identifier)}},this.abort=new AbortController;const e=this.abort.signal;this.overlay=document.createElement("div"),this.overlay.id="touch-overlay",Object.assign(this.overlay.style,{position:"absolute",inset:"0",zIndex:"50",pointerEvents:"none",touchAction:"none"}),t.appendChild(this.overlay),this.joyBase=this.createJoystickBase(),this.joyThumb=this.createJoystickThumb(),this.joyBase.appendChild(this.joyThumb),this.overlay.appendChild(this.joyBase),this.actionBtn=this.createActionButton(W.INTERACT,"🤚",fs),Object.assign(this.actionBtn.style,{position:"absolute",right:`${ee}px`,bottom:`calc(${ee}px + env(safe-area-inset-bottom, 0px))`,display:"none",width:"auto",height:"auto",padding:"12px 20px",fontSize:"15px",borderRadius:"24px",gap:"8px",maxWidth:"200px",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}),this.actionBtnData=this.buttons[this.buttons.length-1],this.overlay.appendChild(this.actionBtn),document.addEventListener("touchstart",this.onTouchStart,{signal:e,passive:!1}),document.addEventListener("touchmove",this.onTouchMove,{signal:e,passive:!1}),document.addEventListener("touchend",this.onTouchEnd,{signal:e,passive:!1}),document.addEventListener("touchcancel",this.onTouchEnd,{signal:e,passive:!1})}isActionActive(t){return t===W.RUN?this.joyRunning:this.activeActions.has(t)}consumeAction(t){return this.pendingActions.delete(t)}getMovementVector(){return this.joyVec}getPointerPosition(){return{x:this.lastPointerX,y:this.lastPointerY}}dispose(){this.abort.abort();for(const t of this.buttons)t.releaseTimer!==null&&clearTimeout(t.releaseTimer);this.overlay.remove()}setInteractVisible(t,e){this.actionBtn.style.display=t?"flex":"none",e!==void 0&&(this.actionBtn.innerHTML=`<span style="filter:brightness(0) invert(1)">🤚</span><span>${this.escapeHtml(e)}</span>`)}escapeHtml(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}updateJoystick(t,e){const s=t-this.joyCenterX,i=e-this.joyCenterY,o=Math.sqrt(s*s+i*i),n=Rt/2,r=Math.min(o,n),l=Math.atan2(i,s),h=Math.cos(l)*r,d=Math.sin(l)*r;this.joyThumb.style.transform=`translate(${h}px, ${d}px)`;const u=r/n;u>.15?this.joyVec={x:Math.cos(l)*Math.min(1,u),y:Math.sin(l)*Math.min(1,u)}:this.joyVec={x:0,y:0};const g=this.joyRunning;this.joyRunning=u>us,this.joyRunning&&!g?this.joyBase.style.borderColor="rgba(200, 170, 100, 0.35)":!this.joyRunning&&g&&(this.joyBase.style.borderColor="rgba(180, 160, 120, 0.15)"),this.joyThumb.style.background=this.joyRunning?"rgba(200, 170, 100, 0.5)":"rgba(200, 170, 100, 0.3)"}resetJoystick(){this.joyTouchId=null,this.joyVec={x:0,y:0},this.joyRunning=!1,this.joyThumb.style.transform="translate(0px, 0px)",this.joyThumb.style.background="rgba(200, 170, 100, 0.3)",this.joyBase.style.borderColor="rgba(180, 160, 120, 0.15)"}handleButtonTouchStart(t){for(const e of this.buttons){const s=e.element.getBoundingClientRect();if(!(s.width===0||s.height===0)&&t.clientX>=s.left&&t.clientX<=s.right&&t.clientY>=s.top&&t.clientY<=s.bottom)return e.touchId=t.identifier,this.activeActions.add(e.action),this.pendingActions.add(e.action),e.element.style.transform="scale(0.9)",e.element.style.opacity="1",e.releaseTimer!==null&&(clearTimeout(e.releaseTimer),e.releaseTimer=null),this.haptic(),!0}return!1}handleButtonTouchEnd(t){for(const e of this.buttons)e.touchId===t&&(e.touchId=null,e.releaseTimer=window.setTimeout(()=>{this.activeActions.delete(e.action),e.element.style.transform="",e.element.style.opacity="",e.releaseTimer=null},ps))}createJoystickBase(){const t=document.createElement("div");return Object.assign(t.style,{position:"absolute",left:`${te}px`,bottom:`calc(${te}px + env(safe-area-inset-bottom, 0px))`,width:`${Rt}px`,height:`${Rt}px`,borderRadius:"50%",background:"rgba(20, 18, 14, 0.18)",border:"2px solid rgba(180, 160, 120, 0.15)",display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"auto",touchAction:"none",transition:"border-color 0.15s"}),t}createJoystickThumb(){const t=document.createElement("div");return Object.assign(t.style,{width:`${Jt}px`,height:`${Jt}px`,borderRadius:"50%",background:"rgba(200, 170, 100, 0.3)",border:"2px solid rgba(200, 170, 100, 0.35)",transition:"background 0.1s",pointerEvents:"none"}),t}createActionButton(t,e,s){const i=document.createElement("div");return Object.assign(i.style,{width:`${s}px`,height:`${s}px`,borderRadius:"12px",background:"rgba(20, 18, 14, 0.45)",border:"2px solid rgba(180, 160, 120, 0.3)",color:"#d0c8a0",fontFamily:"monospace",fontSize:s>44?"20px":"16px",fontWeight:"bold",display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"auto",touchAction:"none",userSelect:"none",transition:"transform 0.08s, opacity 0.08s",opacity:"0.8"}),i.textContent=e,this.buttons.push({action:t,element:i,touchId:null,releaseTimer:null}),i}haptic(){navigator.vibrate?.(12)}}class ms{constructor(t){this.tileMap=t}update(t,e){for(const s of e){const i=s.velocity,o=s.collider;if(!i||!o)continue;const n=s.transform;if(i.vx===0&&i.vy===0)continue;const r=n.x+i.vx*t;this.canMove(r,n.y,o.hw,o.hh,s,e)&&(n.x=r);const l=n.y+i.vy*t;this.canMove(n.x,l,o.hw,o.hh,s,e)&&(n.y=l),n.x=Math.max(c.MAP_PAD_BACK_LEFT+o.hw,Math.min(this.tileMap.cols-c.MAP_PAD_FRONT_RIGHT-o.hw,n.x)),n.y=Math.max(c.MAP_PAD_BACK_RIGHT+o.hh,Math.min(this.tileMap.rows-c.MAP_PAD_FRONT_LEFT-o.hh,n.y))}}canMove(t,e,s,i,o,n){const r=Math.floor(t-s),l=Math.floor(t+s),h=Math.floor(e-i),d=Math.floor(e+i);for(let g=h;g<=d;g++)for(let y=r;y<=l;y++)if(!this.tileMap.isTileWalkable(y,g))return!1;if(this.tileMap.collidesWithObject(t,e,s,i))return!1;const u=o.collider;if(u&&u.solid){const g=o.transform;for(const y of n){if(y===o)continue;const f=y.collider;if(!f||!f.solid)continue;const m=y.transform;if(!(!(Math.abs(t-m.x)<s+f.hw&&Math.abs(e-m.y)<i+f.hh)||Math.abs(g.x-m.x)<s+f.hw&&Math.abs(g.y-m.y)<i+f.hh))return!1}}return!0}}class ys{constructor(){this.x=0,this.y=0,this.z=0}set(t,e,s=0){this.x=t,this.y=e,this.z=s}}class de{constructor(){this.vx=0,this.vy=0}}class Ht{constructor(){this.hw=.3,this.hh=.3,this.solid=!0}}class et{constructor(t){this.transform=new ys,this.velocity=null,this.collider=null,this.animController=null,this.solid=!1,this.layer="character",this.drawScale=1,this.opacity=1,this.blobShadow=null,this.glowEffect=null,this.interactable=!1,this.interactLabel="",this.id=t}}const mt=class mt{constructor(){this.animations=new Map,this.currentKey="",this.currentFrame=0,this.elapsed=0,this.lastDirection="south",this.frozen=!1,this.idleTimer=0}addAnimation(t,e){this.animations.set(t,e),this.currentKey||(this.currentKey=t)}play(t){this.currentKey!==t&&this.animations.has(t)&&(this.currentKey=t,this.currentFrame=0,this.elapsed=0,this.frozen=!1)}update(t){if(this.frozen)return;const e=this.animations.get(this.currentKey);if(!e)return;this.elapsed+=t;const s=1/e.frameRate;this.elapsed>=s&&(this.elapsed-=s,this.currentFrame++,this.currentFrame>=e.frameCount&&(this.currentFrame=e.loop?0:e.frameCount-1))}setFromVelocity(t,e,s){if(Math.abs(t)>=.001||Math.abs(e)>=.001){this.idleTimer=0,this.frozen=!1;const o=this.velocityToDirection(t,e);this.lastDirection=o,this.play("walk_"+o);return}!this.frozen&&this.currentKey.startsWith("walk_")&&(this.currentFrame=0,this.elapsed=0,this.frozen=!0,this.idleTimer=0),this.frozen&&(this.idleTimer+=s,this.idleTimer>=mt.IDLE_TIMEOUT&&(this.frozen=!1,this.play("idle_"+this.lastDirection)))}velocityToDirection(t,e){const s=(Math.atan2(e,t)*180/Math.PI+360)%360;return s>=337.5||s<22.5?"east":s>=22.5&&s<67.5?"south_east":s>=67.5&&s<112.5?"south":s>=112.5&&s<157.5?"south_west":s>=157.5&&s<202.5?"west":s>=202.5&&s<247.5?"north_west":s>=247.5&&s<292.5?"north":"north_east"}getCurrentAssetId(){return this.animations.get(this.currentKey)?.assetId??""}getCurrentFrame(){const t=this.animations.get(this.currentKey);return t?{x:this.currentFrame*t.frameWidth,y:0,width:t.frameWidth,height:t.frameHeight}:{x:0,y:0,width:64,height:64}}getDirection(){return this.lastDirection}};mt.IDLE_TIMEOUT=10;let Q=mt;class ue extends et{constructor(){super("player"),this.screenDirX=0,this.screenDirY=0,this.layer="character",this.velocity=new de,this.collider=new Ht,this.collider.hw=.25,this.collider.hh=.25,this.animController=new Q,this.blobShadow={rx:c.PLAYER_BLOB_SHADOW_RX,ry:c.PLAYER_BLOB_SHADOW_RY,opacity:c.PLAYER_BLOB_SHADOW_OPACITY}}handleInput(t){const e=t.getMovementVector();this.screenDirX=e.x,this.screenDirY=e.y;const s=c.TILE_WIDTH,i=c.TILE_HEIGHT;let o=e.x/s+e.y/i,n=-e.x/s+e.y/i;const r=Math.sqrt(o*o+n*n);r>0&&(o/=r,n/=r);const l=c.PLAYER_SPEED/((s+i)/2),h=t.isRunning()?c.PLAYER_RUN_MULT:1;this.velocity.vx=o*l*h,this.velocity.vy=n*l*h}}class _s{update(t,e){for(const s of e){const i=s.animController;i&&(s instanceof ue?i.setFromVelocity(s.screenDirX,s.screenDirY,t):s.velocity&&i.setFromVelocity(s.velocity.vx,s.velocity.vy,t),i.update(t))}}}var Dt=(a=>(a.WALKING="WALKING",a.IDLE="IDLE",a.SLEEPING="SLEEPING",a))(Dt||{});class It extends et{constructor(t,e){super(t),this.npcState="WALKING",this.interactable=!1,this.fadeElapsed=0,this.layer="character",this.velocity=new de,this.collider=new Ht,this.collider.hw=.05,this.collider.hh=.05,this.collider.solid=!1,this.animController=new Q,this.transform.set(e.spawnCol,e.spawnRow),this.targetCol=e.targetCol,this.targetRow=e.targetRow;const s=(c.TILE_WIDTH+c.TILE_HEIGHT)/2;this.gridSpeed=e.speed/s,this.fadeDuration=e.fadeDuration,this.opacity=0,this.dialogId=e.dialogId,this.aimAtTarget()}update(t){switch(this.npcState){case"WALKING":{this.opacity<1&&(this.fadeElapsed+=t,this.opacity=Math.min(1,this.fadeElapsed/this.fadeDuration));const e=this.targetCol-this.transform.x,s=this.targetRow-this.transform.y,i=Math.sqrt(e*e+s*s),o=this.gridSpeed*t;if(i<Math.max(.1,o)){this.transform.set(this.targetCol,this.targetRow),this.velocity.vx=0,this.velocity.vy=0,this.opacity=1,this.npcState="IDLE",this.interactable=!0,this.interactLabel="поговорить",this.collider.solid=!0;const n=this.animController.getDirection();this.animController.play(`idle_${n}`)}else this.velocity.vx=e/i*this.gridSpeed,this.velocity.vy=s/i*this.gridSpeed;break}}}sleep(){this.npcState="SLEEPING",this.velocity.vx=0,this.velocity.vy=0,this.interactable=!1,this.interactLabel="",this.animController.play("sleep")}aimAtTarget(){const t=this.targetCol-this.transform.x,e=this.targetRow-this.transform.y,s=Math.sqrt(t*t+e*e);s<.01||(this.velocity.vx=t/s*this.gridSpeed,this.velocity.vy=e/s*this.gridSpeed)}}const fe=new Map;function ot(a){return fe.get(a)}function vs(...a){for(const t of a)fe.set(t.id,t)}vs({id:"q_dog_bone",title:"Голодный друг",description:"Пёс выглядит голодным. Покорми его.",objectives:[{description:"Поговорить с псом",type:"talk",target:"dog_greeting",required:1},{description:"Найти кость",type:"collect",target:"bone",required:1},{description:"Отдать кость псу",type:"flag",target:"dog_fed",required:1}],completionFlag:"quest_dog_bone_done"},{id:"q_gather_sticks",title:"Подкинуть дров в костёр",description:"Костёр угасает. Собери хворост и подкинь его в огонь.",objectives:[{description:"Собрать хворост",type:"collect",target:"stick",required:2},{description:"Бросить хворост в костёр",type:"flag",target:"sticks_in_fire",required:1}],completionFlag:"quest_gather_sticks_done"});class Is{constructor(){this.listeners=new Map}on(t,e){this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e)}off(t,e){this.listeners.get(t)?.delete(e)}emit(t,e){this.listeners.get(t)?.forEach(s=>s(e))}clear(){this.listeners.clear()}}const M=new Is;class ws{constructor(){this.flags=new Map}get(t){return this.flags.get(t)}getBool(t){return this.flags.get(t)===!0}getNumber(t){const e=this.flags.get(t);return typeof e=="number"?e:0}getString(t){const e=this.flags.get(t);return typeof e=="string"?e:""}set(t,e){this.flags.set(t,e)}toggle(t){const e=!this.getBool(t);return this.flags.set(t,e),e}increment(t,e=1){const s=this.getNumber(t)+e;return this.flags.set(t,s),s}has(t){return this.flags.has(t)}delete(t){this.flags.delete(t)}clear(){this.flags.clear()}toJSON(){const t={};for(const[e,s]of this.flags)t[e]=s;return t}fromJSON(t){for(const e of Object.keys(t))this.flags.set(e,t[e])}}const J=new ws,pe=new Map;function lt(a){return pe.get(a)}function bs(...a){for(const t of a)pe.set(t.id,t)}bs({id:"stick",name:"Хворост",description:"Крепкая палка хвороста. Хорошо горит.",iconAssetId:"item_stick",stackable:!0,maxStack:10},{id:"bone",name:"Кость",description:"Большая белая кость. Собака была бы в восторге.",iconAssetId:"item_bone",stackable:!0,maxStack:5},{id:"stone",name:"Камень",description:"Гладкий круглый камень. Красивый и подозрительно ровный",iconAssetId:"item_stone",stackable:!0,maxStack:10},{id:"pink_lighter",name:"Неизвестный предмет",description:"Прозрачное розовое стекло, внутри какая-то жидкость. Сзади написано «З А Ж И Г А Л К А». Что это за чертовщина?",iconAssetId:"item_pink_lighter",stackable:!1,maxStack:1,glowColor:"rgba(230, 140, 180, 0.6)"});class Ss{constructor(t=20){this.slots=new Map,this.maxSlots=t}add(t,e=1,s=""){const i=lt(t);if(!i)return 0;const o=this.slots.get(t)??0;if(o===0&&this.slots.size>=this.maxSlots)return 0;const n=i.stackable?i.maxStack-o:o===0?1:0,r=Math.min(e,Math.max(0,n));return r<=0?0:(this.slots.set(t,o+r),M.emit("item:collected",{itemId:t,entityId:s}),this.emitChanged(),r)}remove(t,e=1){const s=this.slots.get(t)??0,i=Math.min(e,s);if(i<=0)return 0;const o=s-i;return o<=0?this.slots.delete(t):this.slots.set(t,o),this.emitChanged(),i}has(t,e=1){return(this.slots.get(t)??0)>=e}count(t){return this.slots.get(t)??0}getSlots(){const t=[];for(const[e,s]of this.slots)t.push({itemId:e,count:s});return t}getItemIds(){const t=[];for(const[e,s]of this.slots)for(let i=0;i<s;i++)t.push(e);return t}get slotCount(){return this.slots.size}get isFull(){return this.slots.size>=this.maxSlots}clear(){this.slots.clear(),this.emitChanged()}toJSON(){const t={};for(const[e,s]of this.slots)t[e]=s;return t}fromJSON(t){this.slots.clear();for(const e of Object.keys(t))this.slots.set(e,t[e]);this.emitChanged()}emitChanged(){M.emit("inventory:changed",{items:this.getItemIds()})}}const B=new Ss;class Ts{constructor(){this.quests=new Map,this.initialized=!1}init(){this.initialized||(this.initialized=!0,M.on("item:collected",({itemId:t})=>{this.advanceObjectives("collect",t)}),M.on("dialog:open",({dialogId:t})=>{this.advanceObjectives("talk",t)}),M.on("trigger:enter",({zoneId:t})=>{this.advanceObjectives("reach",t)}),M.on("dialog:choice",()=>{this.checkFlagObjectives()}))}start(t){const e=ot(t);if(!e)return!1;const s=this.quests.get(t);if(s&&s.status!=="not_started")return!1;if(e.prerequisite){const o=this.quests.get(e.prerequisite);if(!o||o.status!=="completed")return!1}const i={questId:t,status:"active",progress:e.objectives.map(()=>0)};return this.quests.set(t,i),M.emit("quest:started",{questId:t}),this.syncCollectObjectives(i,e),!0}getState(t){return this.quests.get(t)}getStatus(t){return this.quests.get(t)?.status??"not_started"}isActive(t){return this.getStatus(t)==="active"}isCompleted(t){return this.getStatus(t)==="completed"}getActiveQuests(){return Array.from(this.quests.values()).filter(t=>t.status==="active")}getCompletedQuests(){return Array.from(this.quests.values()).filter(t=>t.status==="completed")}getAllStates(){return Array.from(this.quests.values())}checkFlags(){this.checkFlagObjectives()}advanceObjectives(t,e){for(const s of this.quests.values()){if(s.status!=="active")continue;const i=ot(s.questId);if(i){for(let o=0;o<i.objectives.length;o++){const n=i.objectives[o];n.type!==t||n.target!==e||s.progress[o]>=n.required||(t==="collect"?s.progress[o]=B.count(e):s.progress[o]=Math.min(s.progress[o]+1,n.required),s.progress[o]>=n.required&&M.emit("quest:objective_complete",{questId:s.questId,objectiveIndex:o}))}this.checkQuestCompletion(s,i)}}}checkFlagObjectives(){for(const t of this.quests.values()){if(t.status!=="active")continue;const e=ot(t.questId);if(e){for(let s=0;s<e.objectives.length;s++){const i=e.objectives[s];i.type==="flag"&&(t.progress[s]=J.getBool(i.target)?1:0,t.progress[s]>=i.required&&M.emit("quest:objective_complete",{questId:t.questId,objectiveIndex:s}))}this.checkQuestCompletion(t,e)}}}syncCollectObjectives(t,e){for(let s=0;s<e.objectives.length;s++){const i=e.objectives[s];if(i.type!=="collect")continue;const o=B.count(i.target);o>0&&(t.progress[s]=Math.min(o,i.required),t.progress[s]>=i.required&&M.emit("quest:objective_complete",{questId:t.questId,objectiveIndex:s}))}this.checkQuestCompletion(t,e)}checkQuestCompletion(t,e){t.status!=="active"||!e.objectives.every((i,o)=>t.progress[o]>=i.required)||(t.status="completed",e.completionFlag&&J.set(e.completionFlag,!0),M.emit("quest:complete",{questId:t.questId}))}toJSON(){const t={};for(const[e,s]of this.quests)t[e]={status:s.status,progress:s.progress};return t}fromJSON(t){for(const e of Object.keys(t)){const s=t[e];this.quests.set(e,{questId:e,status:s.status,progress:s.progress})}}}const U=new Ts;class Rs{constructor(){this.fps=0,this.frameCount=0,this.fpsTimer=0,this._debugVisible=!1,this._questHudVisible=!0,this._idleMode=!1,this.iconCache=new Map,this.invDirty=!0,this.hudEl=document.getElementById("hud"),this.debugEl=document.getElementById("debug-overlay"),this.hudEl.style.display="none",this.debugEl.style.display="none";let t=document.getElementById("quest-hud");t||(t=document.createElement("div"),t.id="quest-hud",document.getElementById("game-container").appendChild(t)),this.questHudEl=t;let e=document.getElementById("inv-preview");e||(e=document.createElement("div"),e.id="inv-preview",document.getElementById("game-container").appendChild(e)),this.invPreviewEl=e,M.on("inventory:changed",()=>{this.invDirty=!0})}get debugVisible(){return this._debugVisible}setDebugVisible(t){this._debugVisible=t,t||(this.hudEl.style.display="none",this.debugEl.style.display="none")}get questHudVisible(){return this._questHudVisible}setQuestHudVisible(t){this._questHudVisible=t,t||(this.questHudEl.style.display="none")}setIdleMode(t){if(t===this._idleMode)return;this._idleMode=t;const e=t?"0":"1";this.questHudEl.style.transition="opacity 0.6s",this.invPreviewEl.style.transition="opacity 0.6s",this.questHudEl.style.opacity=e,this.invPreviewEl.style.opacity=e}update(t,e,s,i){if(this.frameCount++,this.fpsTimer+=t,this.fpsTimer>=1&&(this.fps=this.frameCount,this.frameCount=0,this.fpsTimer-=1),this._debugVisible){const o=e.transform,n=e.animController.getDirection(),r=B.getSlots().length,l=r>0?`Предметы: ${r}`:"";this.hudEl.style.display="",this.hudEl.innerHTML=`
        Поз: ${o.x.toFixed(1)}, ${o.y.toFixed(1)}<br>
        Напр: ${n}${l?"<br>"+l:""}
      `,this.debugEl.style.display="",this.debugEl.innerHTML=`
        FPS: ${this.fps}<br>
        Масштаб: ${s.zoom.toFixed(1)}x<br>
        Карта: ${i.cols}×${i.rows}<br>
        Объекты: ${i.objects.length}
      `}this.updateQuestHud(),this.updateInvPreview()}updateQuestHud(){if(!this._questHudVisible){this.questHudEl.style.display="none";return}const t=U.getActiveQuests();if(t.length===0){this.questHudEl.style.display="none";return}let e="";for(const s of t){const i=ot(s.questId);if(i){e+=`<div class="quest-hud-title">▸ ${i.title}</div>`;for(let o=0;o<i.objectives.length;o++){const n=i.objectives[o],r=s.progress[o]??0,l=r>=n.required,h=l?"✓":"○",d=l?"done":"",u=n.required>1?` (${Math.min(r,n.required)}/${n.required})`:"";e+=`<div class="quest-hud-obj ${d}">${h} ${n.description}${u}</div>`}}}this.questHudEl.innerHTML=e,this.questHudEl.style.display=""}updateInvPreview(){const t=B.getSlots(),e=t.length===0;if(this.invPreviewEl.classList.toggle("inv-preview-empty",e),this.questHudEl.style.display!=="none"&&this.questHudEl.offsetHeight>0?this.invPreviewEl.style.top=`${this.questHudEl.offsetTop+this.questHudEl.offsetHeight+6}px`:this.invPreviewEl.style.top="",!this.invDirty){this.invPreviewEl.style.display="block";return}this.invDirty=!1;let s="";if(!e){s+='<div class="inv-preview-items">';for(const i of t){const o=lt(i.itemId);if(!o)continue;const n=this.getIconDataUrl(o.iconAssetId),r=n?`<img src="${n}" width="20" height="20" class="inv-preview-icon">`:`<span class="inv-preview-icon-fallback">${o.name[0]}</span>`,l=i.count>1?`<span class="inv-preview-count">×${i.count}</span>`:"";s+=`<div class="inv-preview-slot" title="${o.name}">${r}${l}</div>`}s+="</div>"}s+='<div class="inv-preview-bag">🎒</div>',s+='<div class="inv-preview-questlog">📜</div>',s+='<div class="inv-preview-hint"><span class="inv-preview-key">I</span> — инвентарь</div>',this.invPreviewEl.innerHTML=s,this.invPreviewEl.style.display=""}getIconDataUrl(t){const e=this.iconCache.get(t);if(e)return e;const s=b.get(t);if(!s)return null;const i=b.getSize(t),o=i?.width??24,n=i?.height??24,r=Math.min(20/o,20/n),l=Math.round(o*r),h=Math.round(n*r),d=document.createElement("canvas");d.width=20,d.height=20;const u=d.getContext("2d");u.imageSmoothingEnabled=!1,u.drawImage(s,0,0,o,n,Math.round((20-l)/2),Math.round((20-h)/2),l,h);const g=d.toDataURL();return this.iconCache.set(t,g),g}}const yt=class yt{constructor(){this.keydownHandler=null,this.closeBtnHandler=null,this.selectedIndex=0,this.choiceCount=0,this.container=document.getElementById("dialog-container"),this.speakerEl=this.container.querySelector(".dialog-speaker"),this.textEl=this.container.querySelector(".dialog-text"),this.choicesEl=this.container.querySelector(".dialog-choices"),this.closeBtn=this.container.querySelector(".dialog-close")}show(t,e,s){this.removeListeners(),this.speakerEl.textContent=t.speaker,this.textEl.textContent=t.text,this.choicesEl.innerHTML="",this.choiceCount=t.choices.length,this.selectedIndex=0,t.choices.forEach((i,o)=>{const n=document.createElement("li");n.className="dialog-choice";const r=i.tag?`<span class="dialog-tag dialog-tag--${i.tag}">${yt.TAG_LABELS[i.tag]??i.tag}</span> `:"";n.innerHTML=`<span class="dialog-choice-pointer">▸</span> ${r}${this.escapeHtml(i.text)}`,n.addEventListener("click",()=>e(o)),n.addEventListener("mouseenter",()=>{this.selectedIndex=o,this.highlightSelected()}),this.choicesEl.appendChild(n)}),this.highlightSelected(),this.closeBtnHandler=()=>s(),this.closeBtn.addEventListener("click",this.closeBtnHandler),this.keydownHandler=i=>{switch(i.code){case"Escape":i.preventDefault(),i.stopPropagation(),s();return;case"ArrowUp":case"KeyW":i.preventDefault(),i.stopPropagation(),this.selectedIndex=(this.selectedIndex-1+this.choiceCount)%this.choiceCount,this.highlightSelected();return;case"ArrowDown":case"KeyS":i.preventDefault(),i.stopPropagation(),this.selectedIndex=(this.selectedIndex+1)%this.choiceCount,this.highlightSelected();return;case"Enter":case"Space":i.preventDefault(),i.stopPropagation(),e(this.selectedIndex);return}},window.addEventListener("keydown",this.keydownHandler),this.container.style.display="flex"}hide(){this.container.style.display="none",this.removeListeners()}get visible(){return this.container.style.display!=="none"}highlightSelected(){this.choicesEl.querySelectorAll(".dialog-choice").forEach((e,s)=>{e.classList.toggle("selected",s===this.selectedIndex)})}removeListeners(){this.keydownHandler&&(window.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=null),this.closeBtnHandler&&(this.closeBtn.removeEventListener("click",this.closeBtnHandler),this.closeBtnHandler=null)}escapeHtml(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}};yt.TAG_LABELS={quest:"Квест",action:"Действие",new:"Новое"};let xt=yt;class Es{constructor(){this.keydownHandler=null,this.selectedIndex=0,this.slotCount=0,this.slotItemIds=[],this.onInspect=null,this.onClose=null;let t=document.getElementById("inventory-container");t||(t=document.createElement("div"),t.id="inventory-container",t.innerHTML=`
        <div class="inventory-box" style="position:relative">
          <button class="overlay-close" aria-label="Закрыть">✕</button>
          <div class="inventory-title">ИНВЕНТАРЬ</div>
          <div class="inventory-slots"></div>
          <div class="inventory-hint">
            <span class="keyboard-hint">
              <span class="key">↑</span><span class="key">↓</span> выбор
              <span class="key">Enter</span> осмотреть
              <span class="key">ESC</span> закрыть
            </span>
            <span class="touch-hint">Нажмите на предмет</span>
          </div>
        </div>
      `,document.getElementById("game-container").appendChild(t)),this.container=t,this.container.style.display="none",this.slotsEl=t.querySelector(".inventory-slots"),this.hintEl=t.querySelector(".inventory-hint"),t.querySelector(".overlay-close").addEventListener("click",()=>this.onClose?.())}show(t,e){this.onInspect=t??null,this.onClose=e??null,this.refresh(),this.container.style.display="flex",this.attachKeyListener()}hide(){this.container.style.display="none",this.removeKeyListener()}get visible(){return this.container.style.display!=="none"}refresh(){this.slotsEl.innerHTML="";const t=B.getSlots();if(this.slotItemIds=[],t.length===0){this.slotCount=0;const e=document.createElement("div");e.className="inventory-empty",e.textContent="Пусто",this.slotsEl.appendChild(e);return}this.slotCount=t.length,this.selectedIndex>=this.slotCount&&(this.selectedIndex=Math.max(0,this.slotCount-1));for(const e of t){const s=lt(e.itemId);if(!s)continue;this.slotItemIds.push(e.itemId);const i=document.createElement("div");i.className="inventory-slot";const o=document.createElement("span");o.className="inventory-pointer",o.textContent="▸",i.appendChild(o);const n=b.get(s.iconAssetId);if(n){const h=document.createElement("canvas");h.width=32,h.height=32,h.className="inventory-icon";const d=h.getContext("2d");if(s.glowColor){const p=d.createRadialGradient(16,16,0,16,16,16);p.addColorStop(0,s.glowColor.replace(/[\d.]+\)$/,"0.75)")),p.addColorStop(.25,s.glowColor.replace(/[\d.]+\)$/,"0.5)")),p.addColorStop(.5,s.glowColor.replace(/[\d.]+\)$/,"0.25)")),p.addColorStop(.75,s.glowColor.replace(/[\d.]+\)$/,"0.08)")),p.addColorStop(1,"rgba(0,0,0,0)"),d.fillStyle=p,d.fillRect(0,0,32,32)}d.imageSmoothingEnabled=!1;const u=b.getSize(s.iconAssetId),g=u?.width??24,y=u?.height??24,f=Math.min(24/g,24/y),m=Math.round(g*f),v=Math.round(y*f),I=Math.round((32-m)/2),_=Math.round((32-v)/2);d.drawImage(n,0,0,g,y,I,_,m,v),i.appendChild(h)}else{const h=document.createElement("div");h.className="inventory-icon-fallback",h.textContent=s.name[0],i.appendChild(h)}if(e.count>1){const h=document.createElement("span");h.className="inventory-count",h.textContent=`×${e.count}`,i.appendChild(h)}const r=document.createElement("span");r.className="inventory-name",r.textContent=s.name,i.appendChild(r);const l=this.slotItemIds.length-1;i.addEventListener("click",()=>{this.selectedIndex=l,this.highlightSelected(),this.slotItemIds[l]&&this.onInspect?.(this.slotItemIds[l])}),this.slotsEl.appendChild(i)}this.highlightSelected()}highlightSelected(){this.slotsEl.querySelectorAll(".inventory-slot").forEach((e,s)=>{e.classList.toggle("selected",s===this.selectedIndex)})}attachKeyListener(){this.removeKeyListener(),this.keydownHandler=t=>{if(this.slotCount===0){(t.code==="Escape"||t.code==="KeyI")&&(t.preventDefault(),t.stopPropagation(),this.onClose?.());return}switch(t.code){case"ArrowUp":case"KeyW":t.preventDefault(),t.stopPropagation(),this.selectedIndex=(this.selectedIndex-1+this.slotCount)%this.slotCount,this.highlightSelected();break;case"ArrowDown":case"KeyS":t.preventDefault(),t.stopPropagation(),this.selectedIndex=(this.selectedIndex+1)%this.slotCount,this.highlightSelected();break;case"Enter":case"Space":t.preventDefault(),t.stopPropagation(),this.slotItemIds[this.selectedIndex]&&this.onInspect?.(this.slotItemIds[this.selectedIndex]);break;case"Escape":case"KeyI":t.preventDefault(),t.stopPropagation(),this.onClose?.();break}},window.addEventListener("keydown",this.keydownHandler)}removeKeyListener(){this.keydownHandler&&(window.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=null)}}class Ms{constructor(){let t=document.getElementById("questlog-container");t||(t=document.createElement("div"),t.id="questlog-container",t.innerHTML=`
        <div class="questlog-box" style="position:relative">
          <button class="overlay-close" aria-label="Закрыть">✕</button>
          <div class="questlog-title">ЖУРНАЛ ЗАДАНИЙ</div>
          <div class="questlog-content"></div>
          <div class="questlog-hint">
            <span class="keyboard-hint"><span class="key">J</span> / <span class="key">ESC</span> закрыть</span>
          </div>
        </div>
      `,document.getElementById("game-container").appendChild(t)),this.container=t,this.container.style.display="none",this.contentEl=t.querySelector(".questlog-content"),t.querySelector(".overlay-close").addEventListener("click",()=>this.hide())}show(){this.refresh(),this.container.style.display="flex"}hide(){this.container.style.display="none"}get visible(){return this.container.style.display!=="none"}refresh(){this.contentEl.innerHTML="";const t=U.getActiveQuests(),e=U.getCompletedQuests();if(t.length===0&&e.length===0){const s=document.createElement("div");s.className="questlog-empty",s.textContent="Заданий пока нет.",this.contentEl.appendChild(s);return}if(t.length>0){const s=document.createElement("div");s.className="questlog-section",s.textContent="— Активные —",this.contentEl.appendChild(s);for(const i of t)this.contentEl.appendChild(this.renderQuest(i.questId,!1))}if(e.length>0){const s=document.createElement("div");s.className="questlog-section",s.textContent="— Завершённые —",this.contentEl.appendChild(s);for(const i of e)this.contentEl.appendChild(this.renderQuest(i.questId,!0))}}renderQuest(t,e){const s=ot(t),i=U.getState(t),o=document.createElement("div");o.className=`questlog-quest ${e?"completed":""}`;const n=document.createElement("div");if(n.className="questlog-quest-title",n.textContent=(e?"✓ ":"▸ ")+(s?.title??t),o.appendChild(n),s&&i)for(let r=0;r<s.objectives.length;r++){const l=s.objectives[r],h=i.progress[r]??0,d=h>=l.required,u=document.createElement("div");u.className=`questlog-objective ${d?"done":""}`,u.textContent=`  ${d?"✓":"○"} ${l.description}`,l.required>1&&(u.textContent+=` (${Math.min(h,l.required)}/${l.required})`),o.appendChild(u)}return o}}class xs{constructor(){let t=document.getElementById("controls-help-container");t||(t=document.createElement("div"),t.id="controls-help-container",t.innerHTML=`
        <div class="controls-help-box">
          <div class="controls-help-title">УПРАВЛЕНИЕ</div>
          <div class="controls-help-content">
            <div class="controls-help-section">Движение</div>
            <div class="controls-help-row"><span class="key">WASD</span> / <span class="key">Стрелки</span> <span class="controls-help-desc">Ходить</span></div>
            <div class="controls-help-row"><span class="key">Shift</span> <span class="controls-help-desc">Бежать</span></div>
            <div class="controls-help-row"><span class="key">Scroll</span> <span class="controls-help-desc">Масштаб</span></div>
            <div class="controls-help-section">Взаимодействие</div>
            <div class="controls-help-row"><span class="key">E</span> <span class="controls-help-desc">Действие / Разговор</span></div>
            <div class="controls-help-row"><span class="key">I</span> <span class="controls-help-desc">Инвентарь</span></div>
            <div class="controls-help-row"><span class="key">J</span> <span class="controls-help-desc">Журнал заданий</span></div>
            <div class="controls-help-section">Окружение</div>
            <div class="controls-help-row"><span class="key">N</span> <span class="controls-help-desc">Вкл/выкл снег</span></div>
            <div class="controls-help-row"><span class="key">T</span> <span class="controls-help-desc">День / Ночь</span></div>
            <div class="controls-help-section">Отладка</div>
            <div class="controls-help-row"><span class="key">L</span> <span class="controls-help-desc">Вкл/выкл освещение</span></div>
            <div class="controls-help-row"><span class="key">G</span> <span class="controls-help-desc">Сетка (удерживать)</span></div>
            <div class="controls-help-row"><span class="key">U</span> <span class="controls-help-desc">Отладочная панель</span></div>
          </div>
          <div class="controls-help-hint"><span class="key">H</span> / <span class="key">ESC</span> закрыть</div>
        </div>
      `,document.getElementById("game-container").appendChild(t)),this.container=t,this.container.style.display="none"}show(){this.container.style.display="flex"}hide(){this.container.style.display="none"}get visible(){return this.container.style.display!=="none"}}class Gt{constructor(){this.isTransparent=!1,this.blocksUpdate=!1}onEnter(){}onExit(){}onPause(){}onResume(){}}class As{constructor(){this.stack=[]}push(t){this.peek()?.onPause(),this.stack.push(t),t.onEnter()}pop(){const t=this.stack.pop();return t?.onExit(),this.peek()?.onResume(),t}replace(t){this.stack.pop()?.onExit(),this.stack.push(t),t.onEnter()}peek(){return this.stack.length>0?this.stack[this.stack.length-1]:void 0}get size(){return this.stack.length}update(t){let e=this.stack.length-1;for(let s=this.stack.length-1;s>=0&&(e=s,!this.stack[s].blocksUpdate);s--);for(let s=e;s<this.stack.length;s++)this.stack[s].update(t)}render(t){let e=this.stack.length-1;for(let s=this.stack.length-1;s>=0&&(e=s,!!this.stack[s].isTransparent);s--);for(let s=e;s<this.stack.length;s++)this.stack[s].render(t)}}class se extends Gt{constructor(t,e,s){super(),this.isTransparent=!0,this.blocksUpdate=!0,this.tree=t,this.currentNodeId=t.startNodeId,this.ui=e,this.onClose=s}onEnter(){M.emit("dialog:open",{dialogId:this.tree.id,npcId:this.tree.id}),this.showCurrentNode()}onExit(){this.ui.hide(),M.emit("dialog:close",{dialogId:this.tree.id})}update(t){}render(t){}showCurrentNode(){const t=this.tree.nodes[this.currentNodeId];if(!t){this.onClose();return}const e=[];for(let i=0;i<t.choices.length;i++){const o=t.choices[i];(!o.condition||o.condition(J))&&e.push({original:o,originalIndex:i})}if(e.length===0){this.onClose();return}const s={...t,choices:e.map(i=>i.original)};this.ui.show(s,i=>{const o=e[i];if(!o)return;const n=o.original;if(n.onSelect?.(J),M.emit("dialog:choice",{dialogId:this.tree.id,choiceIndex:o.originalIndex}),n.nextNodeId===null){this.onClose();return}this.currentNodeId=n.nextNodeId,this.showCurrentNode()},()=>{this.onClose()})}}class Os{constructor(){this.keydownHandler=null,this.clickHandler=null,this.container=document.getElementById("item-preview-container"),this.container.style.display="none",this.labelEl=this.container.querySelector(".item-preview-label"),this.iconCanvas=this.container.querySelector(".item-preview-icon"),this.nameEl=this.container.querySelector(".item-preview-name"),this.descEl=this.container.querySelector(".item-preview-desc")}show(t,e,s){this.removeKeyListener();const i=b.get(t.iconAssetId),o=this.iconCanvas;o.width=64,o.height=64;const n=o.getContext("2d");if(o.width=120,o.height=120,n.clearRect(0,0,120,120),t.glowColor){const r=n.createRadialGradient(60,60,0,60,60,60);r.addColorStop(0,t.glowColor.replace(/[\d.]+\)$/,"0.8)")),r.addColorStop(.2,t.glowColor.replace(/[\d.]+\)$/,"0.6)")),r.addColorStop(.45,t.glowColor.replace(/[\d.]+\)$/,"0.35)")),r.addColorStop(.7,t.glowColor.replace(/[\d.]+\)$/,"0.12)")),r.addColorStop(1,"rgba(0,0,0,0)"),n.fillStyle=r,n.fillRect(0,0,120,120)}if(n.imageSmoothingEnabled=!1,i){const r=b.getSize(t.iconAssetId),l=r?.width??24,h=r?.height??24,d=Math.min(80/l,80/h),u=Math.round(l*d),g=Math.round(h*d),y=Math.round((120-u)/2),f=Math.round((120-g)/2);n.drawImage(i,0,0,l,h,y,f,u,g)}this.labelEl.style.display=s?.showLabel!==!1?"":"none",this.nameEl.textContent=t.name,this.descEl.textContent=t.description,this.container.style.display="flex",this.keydownHandler=r=>{(r.code==="Enter"||r.code==="Space"||r.code==="Escape")&&(r.preventDefault(),r.stopPropagation(),e())},this.clickHandler=()=>e(),requestAnimationFrame(()=>{this.keydownHandler&&window.addEventListener("keydown",this.keydownHandler),this.clickHandler&&this.container.addEventListener("click",this.clickHandler)})}hide(){this.container.style.display="none",this.removeKeyListener()}get visible(){return this.container.style.display!=="none"}removeKeyListener(){this.keydownHandler&&(window.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=null),this.clickHandler&&(this.container.removeEventListener("click",this.clickHandler),this.clickHandler=null)}}const nt=class nt{constructor(){this.keydownHandler=null,this.clickHandler=null;let t=document.getElementById("note-container");t||(t=document.createElement("div"),t.id="note-container",t.innerHTML=`<div class="note-parchment">${nt.DEFAULT_HTML}</div>`,document.getElementById("game-container").appendChild(t)),this.container=t,this.parchment=t.querySelector(".note-parchment"),this.container.style.display="none"}show(t,e){this.parchment.innerHTML=e??nt.DEFAULT_HTML,this.removeListeners(),this.container.style.display="flex",this.keydownHandler=s=>{(s.code==="Enter"||s.code==="Space"||s.code==="Escape")&&(s.preventDefault(),s.stopPropagation(),t())},this.clickHandler=()=>t(),requestAnimationFrame(()=>{this.keydownHandler&&window.addEventListener("keydown",this.keydownHandler),this.clickHandler&&this.container.addEventListener("click",this.clickHandler)})}hide(){this.container.style.display="none",this.removeListeners()}get visible(){return this.container.style.display!=="none"}removeListeners(){this.keydownHandler&&(window.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=null),this.clickHandler&&(this.container.removeEventListener("click",this.clickHandler),this.clickHandler=null)}};nt.DEFAULT_HTML=`
    <div class="note-title">Записка зрителю</div>
    <div class="note-body">
      <p>Этот проект не имеет какого-то глубокого смысла – это сценка-бродилка, с помощью которой я исследовал возможности и ограничения художественной выразительности этого формата. Тем не менее, я оставил тут пару пасхалок на будущее и от скуки.</p>
      <p>Поэтому призываю не относиться к этому проекту слишком серьёзно, но буду рад, если он кого-то вдохновит или кто-то захочет подключиться, чтобы сделать что-то совместно.</p>
      <p>Спасибо, что зашли.</p>
      <p class="note-signature">– Миша</p>
    </div>
    <div class="note-hint">
      <span class="keyboard-hint">Нажмите <span class="key">Enter</span> или <span class="key">ESC</span> чтобы закрыть</span>
      <span class="touch-hint">Нажмите чтобы закрыть</span>
    </div>
  `;let At=nt;const ge={};function ie(a){return ge[a]}function me(a){ge[a.id]=a}const Ls={id:"dog_greeting",startNodeId:"start",nodes:{start:{speaker:"Пёс",text:"*виляет хвостом и смотрит на тебя большими тёплыми глазами*",choices:[{text:"Где ты пропадал? Я начал переживать!",nextNodeId:"lost",condition:()=>!U.isActive("q_dog_bone")&&!U.isCompleted("q_dog_bone")},{text:"Вот, погрызи!",nextNodeId:"give_bone",tag:"quest",condition:()=>B.has("bone")&&U.isActive("q_dog_bone"),onSelect:a=>{B.remove("bone",B.count("bone")),a.set("dog_fed",!0)}},{text:"Ждёшь? Скоро найду, потерпи.",nextNodeId:null,condition:()=>U.isActive("q_dog_bone")&&!B.has("bone")},{text:"(Пёс выглядит довольным.)",nextNodeId:"end_happy_quest",condition:a=>a.getBool("dog_fed")},{text:"Опять ты! Кыш, проваливай!",nextNodeId:"shoo",condition:()=>!U.isActive("q_dog_bone")&&!U.isCompleted("q_dog_bone")}]},lost:{speaker:"Пёс",text:"*наклоняет голову и тихонько ворчит, потом тычется носом в твою руку*",choices:[{text:"Ну, хорошо. Найду тебе что-нибудь.",nextNodeId:"quest_accept",condition:a=>!a.getBool("quest_dog_bone_done")&&!U.isActive("q_dog_bone"),onSelect:a=>{U.start("q_dog_bone"),M.emit("dialog:open",{dialogId:"dog_greeting",npcId:"dog"})}}]},quest_accept:{speaker:"Пёс",text:"*оживляется и принюхивается с надеждой, хвост виляет быстрее*",choices:[{text:"[Уйти]",nextNodeId:null}]},waiting:{speaker:"Пёс",text:"*нетерпеливо принюхивается, заглядывает в твои руки и разочарованно вздыхает*",choices:[{text:"Скоро найду, потерпи.",nextNodeId:null}]},give_bone:{speaker:"Пёс",text:"*глаза округляются, радостно берёт кость и начинает грызть её с явным наслаждением!*",choices:[{text:"Ну ты, серый!",nextNodeId:"end_happy_quest"}]},end_happy_quest:{speaker:"Пёс",text:"*довольно укладывается, радостный, и засыпает перед костром*",choices:[{text:"[Конец]",nextNodeId:null}]},shoo:{speaker:"Пёс",text:"*прижимает уши и смотрит в землю...*",choices:[{text:"...Лааадно, вспылил, прости. День сегодня не задался.",nextNodeId:"lost"},{text:"[Уйти]",nextNodeId:null}]},end_stay:{speaker:"Пёс",text:"*послушно садится и провожает тебя взглядом, полным надежды*",choices:[{text:"[Конец]",nextNodeId:null}]}}},Cs={id:"door_mystery",startNodeId:"start",nodes:{start:{speaker:"???",text:"ЧТО ЗА ЧЕРТОВЩИНА?",choices:[{text:"Открыть дверь",nextNodeId:null,tag:"action",onSelect:()=>{M.emit("door:reveal",{})}}]}}};me(Ls);me(Cs);class Ps{constructor(){this.entities=new Map}add(t){this.entities.set(t.id,t),M.emit("entity:added",{entity:t})}remove(t){const e=this.entities.delete(t);return e&&M.emit("entity:removed",{entityId:t}),e}get(t){return this.entities.get(t)}has(t){return this.entities.has(t)}getAll(){return Array.from(this.entities.values())}getByPrefix(t){const e=[];for(const[s,i]of this.entities)s.startsWith(t)&&e.push(i);return e}getInRadius(t,e,s){const i=s*s,o=[];for(const n of this.entities.values()){const r=n.transform.x-t,l=n.transform.y-e;r*r+l*l<=i&&o.push(n)}return o}get count(){return this.entities.size}clear(){this.entities.clear()}}const ks={breathFreq:.4,breathAmp:.12,wobbleFreq:1.8,wobbleAmp:.08,crackleRate:12,crackleAmp:.1,radiusFollow:.5,baseR:1,baseG:.55,baseB:.12,colorShift:.3};class Hs{constructor(t){this.time=0,this.crackleAccum=0,this.crackleValue=0,this.intensity=1,this.radius=1,this.r=1,this.g=.55,this.b=.12,this.cfg={...ks,...t},this.wobblePhase=Math.random()*Math.PI*2,this.time=Math.random()*100,this.crackleValue=(Math.random()-.5)*2}configure(t){Object.assign(this.cfg,t)}update(t){this.time+=t;const e=this.cfg,s=Math.sin(this.time*e.breathFreq*Math.PI*2)*e.breathAmp,i=(Math.sin(this.time*e.wobbleFreq*Math.PI*2+this.wobblePhase)*.6+Math.sin(this.time*e.wobbleFreq*Math.PI*2*1.7+this.wobblePhase+2.3)*.4)*e.wobbleAmp;this.crackleAccum+=t;const o=1/e.crackleRate;this.crackleAccum>=o&&(this.crackleAccum-=o,this.crackleValue+=((Math.random()-.5)*2-this.crackleValue)*.6);const n=this.crackleValue*e.crackleAmp,r=1+s+i+n;this.intensity=Math.max(.3,r),this.radius=1+(r-1)*e.radiusFollow;const l=(r-1)*e.colorShift;this.r=Math.min(1,e.baseR+l*.05),this.g=Math.min(1,Math.max(0,e.baseG+l*.4)),this.b=Math.min(1,Math.max(0,e.baseB+l*.3))}}const z={name:"Night",ambientR:.18,ambientG:.22,ambientB:.38,bgR:.024,bgG:.024,bgB:.07,skyLightOffsetX:-2e3,skyLightOffsetY:300,skyLightRadius:3500,skyLightR:.75,skyLightG:.8,skyLightB:1,skyLightIntensity:.55,shadowLengthMult:2,shadowOpacity:1,pointLightOpacity:1,fireOpacity:1,volRimR:.6,volRimG:.75,volRimB:1,snowOpacity:1,vignetteOpacity:1,vignetteR:.024,vignetteG:.024,vignetteB:.07,fogWispOpacity:1,fogWispR:.024,fogWispG:.024,fogWispB:.07,fogWispAdditive:!0},oe={name:"Day",ambientR:.95,ambientG:.95,ambientB:.95,bgR:.72,bgG:.84,bgB:.96,skyLightOffsetX:-800,skyLightOffsetY:-1200,skyLightRadius:5e3,skyLightR:1,skyLightG:1,skyLightB:.98,skyLightIntensity:.35,shadowLengthMult:.4,shadowOpacity:.25,pointLightOpacity:0,fireOpacity:0,volRimR:.95,volRimG:.95,volRimB:1,snowOpacity:.1,vignetteOpacity:.7,vignetteR:.278,vignetteG:.373,vignetteB:.518,fogWispOpacity:.85,fogWispR:.851,fogWispG:.851,fogWispB:.851,fogWispAdditive:!1};function Ds(a,t,e){const s=(i,o)=>i+(o-i)*e;return{name:e<.5?a.name:t.name,ambientR:s(a.ambientR,t.ambientR),ambientG:s(a.ambientG,t.ambientG),ambientB:s(a.ambientB,t.ambientB),bgR:s(a.bgR,t.bgR),bgG:s(a.bgG,t.bgG),bgB:s(a.bgB,t.bgB),skyLightOffsetX:s(a.skyLightOffsetX,t.skyLightOffsetX),skyLightOffsetY:s(a.skyLightOffsetY,t.skyLightOffsetY),skyLightRadius:s(a.skyLightRadius,t.skyLightRadius),skyLightR:s(a.skyLightR,t.skyLightR),skyLightG:s(a.skyLightG,t.skyLightG),skyLightB:s(a.skyLightB,t.skyLightB),skyLightIntensity:s(a.skyLightIntensity,t.skyLightIntensity),shadowLengthMult:s(a.shadowLengthMult,t.shadowLengthMult),shadowOpacity:s(a.shadowOpacity,t.shadowOpacity),pointLightOpacity:s(a.pointLightOpacity,t.pointLightOpacity),fireOpacity:s(a.fireOpacity,t.fireOpacity),volRimR:s(a.volRimR,t.volRimR),volRimG:s(a.volRimG,t.volRimG),volRimB:s(a.volRimB,t.volRimB),snowOpacity:s(a.snowOpacity,t.snowOpacity),vignetteOpacity:s(a.vignetteOpacity,t.vignetteOpacity),vignetteR:s(a.vignetteR,t.vignetteR),vignetteG:s(a.vignetteG,t.vignetteG),vignetteB:s(a.vignetteB,t.vignetteB),fogWispOpacity:s(a.fogWispOpacity,t.fogWispOpacity),fogWispR:s(a.fogWispR,t.fogWispR),fogWispG:s(a.fogWispG,t.fogWispG),fogWispB:s(a.fogWispB,t.fogWispB),fogWispAdditive:e<.5?a.fogWispAdditive:t.fogWispAdditive}}class Gs extends Gt{constructor(t){super(),this.game=t}update(t){this.game._update(t)}render(t){this.game._render(t)}}class tt extends et{constructor(t,e){super(t),this.depleted=!1,this.layer="ground",this.solid=!1,this.opacity=0,this.interactable=!0,this.interactLabel=e.label,this.transform.set(e.col,e.row),this.onInteractCb=e.onInteract,this.interactRadius=e.radius??.8,this.markerOffsetY=e.markerOffsetY??0}interact(){return this.depleted?!1:this.onInteractCb()}deplete(){this.depleted=!0,this.interactable=!1}}const F=class F extends et{constructor(t,e){super("campfire"),this.sparks=[],this.maxSparks=30,this.spawnAccum=0,this.spawnRate=14,this.burstPhase="off",this.burstPhaseTimer=0,this.burstHoldDuration=0,this.burstT=0,this.savedMaxSparks=30,this.savedSpawnRate=14,this.burstPeakMaxSparks=50,this.burstPeakSpawnRate=30,this.burstPeakScaleMult=1.25,this.burstPeakLightMult=1.2,this._fed=!1,this.baseDrawScale=1,this._scaleMult=.7,this._lightMult=.8,this.layer="object",this.solid=!0,this.opacity=1,this.drawScale=1,this.transform.set(t,e),this.collider=new Ht,this.collider.hw=.1,this.collider.hh=.1,this.collider.solid=!0,this.animController=new Q}get fed(){return this._fed}get scaleMult(){return this._scaleMult}get lightMult(){return this._lightMult*this.currentBurstLightMult()}currentBurstLightMult(){return F.lerp(1,this.burstPeakLightMult,this.burstT)}static lerp(t,e,s){return t+(e-t)*s}static easeIn(t){return t*t}static easeOut(t){return 1-(1-t)*(1-t)}burst(t=2){this.savedMaxSparks=this.maxSparks,this.savedSpawnRate=this.spawnRate,this.burstPeakMaxSparks=50,this.burstPeakSpawnRate=30,this.burstPeakScaleMult=1.25,this.burstPeakLightMult=1.2,this.burstHoldDuration=Math.max(0,t-F.BURST_RAMP_UP-F.BURST_RAMP_DOWN),this.burstPhase="up",this.burstPhaseTimer=0,this.burstT=0}feed(){this._fed=!0,this._scaleMult=1,this._lightMult=1,this.applyBurstDerived()}setBaseScale(t){this.baseDrawScale=t,this.applyBurstDerived()}applyBurstDerived(){const t=this.burstT,e=F.lerp(1,this.burstPeakScaleMult,t);this.drawScale=this.baseDrawScale*this._scaleMult*e,this.spawnRate=F.lerp(this.savedSpawnRate,this.burstPeakSpawnRate,t),this.maxSparks=Math.round(F.lerp(this.savedMaxSparks,this.burstPeakMaxSparks,t))}updateSparks(t){if(this.burstPhase!=="off"){switch(this.burstPhaseTimer+=t,this.burstPhase){case"up":this.burstPhaseTimer>=F.BURST_RAMP_UP?(this.burstT=1,this.burstPhase="hold",this.burstPhaseTimer-=F.BURST_RAMP_UP):this.burstT=F.easeIn(this.burstPhaseTimer/F.BURST_RAMP_UP);break;case"hold":this.burstT=1,this.burstPhaseTimer>=this.burstHoldDuration&&(this.burstPhase="down",this.burstPhaseTimer-=this.burstHoldDuration);break;case"down":this.burstPhaseTimer>=F.BURST_RAMP_DOWN?(this.burstT=0,this.burstPhase="off",this.burstPhaseTimer=0):this.burstT=F.easeOut(1-this.burstPhaseTimer/F.BURST_RAMP_DOWN);break}this.applyBurstDerived()}this.spawnAccum+=t;const e=1/this.spawnRate;for(;this.spawnAccum>=e&&this.sparks.length<this.maxSparks;)this.spawnAccum-=e,this.sparks.push(this.makeSpark());for(let s=this.sparks.length-1;s>=0;s--){const i=this.sparks[s];if(i.life-=t,i.life<=0){this.sparks.splice(s,1);continue}i.ox+=i.vx*t,i.oy+=i.vy*t,i.vx*=.97,i.vy*=.98}}makeSpark(){const t=-Math.PI/2+(Math.random()-.5)*1.4,e=18+Math.random()*40,s=.8+Math.random()*1.4;return{ox:(Math.random()-.5)*14,oy:-4-Math.random()*10,vx:Math.cos(t)*e,vy:Math.sin(t)*e,life:s,maxLife:s,radius:1.5+Math.random()*1.8,hue:Math.random()}}};F.BURST_RAMP_UP=.3,F.BURST_RAMP_DOWN=.5;let gt=F;class Ws{constructor(t,e,s){this.entityManager=t,this.inputManager=e,this.interactPrompt=s,this.nearestInteractId=null,this.nearestInteractLabel=null}hidePrompt(){this.interactPrompt.style.display="none"}update(t,e){let s=null,i=1/0,o=null,n=1/0;for(const h of this.entityManager.getAll()){if(!h.interactable)continue;const d=h instanceof tt?h.interactRadius:c.NPC_INTERACT_RADIUS,u=c.NPC_ONBOARD_RADIUS,g=h.transform.x-t,y=h.transform.y-e,f=Math.sqrt(g*g+y*y);f<=d&&f<i&&(s=h,i=f),f<=u&&f<n&&(o=h,n=f)}if(this.nearestInteractId=o?.id??null,s){const h=s.interactLabel||"действовать";this.nearestInteractLabel=h,this.interactPrompt.innerHTML=`Нажмите <span class="key">E</span> — ${h}`,this.interactPrompt.style.display=""}else this.nearestInteractLabel=null,this.interactPrompt.style.display="none";const r=this.inputManager.consumeAction(W.INTERACT);let l=null;return r&&s&&(s instanceof It?l={type:"npc",entity:s}:s instanceof tt?l={type:"interactable",entity:s}:s instanceof gt&&(l={type:"campfire",entity:s})),l}}var Ot=(a=>(a.IDLE="IDLE",a.PICKING_UP="PICKING_UP",a.DONE="DONE",a.LAUNCHING="LAUNCHING",a))(Ot||{});const _t=class _t extends et{constructor(t,e){super(t),this.state="IDLE",this.bobTime=0,this.bobPhase=Math.random()*Math.PI*2,this.pickupT=0,this.launchFrom={x:0,y:0},this.launchTo={x:0,y:0},this.launchDuration=.9,this.launchT=0,this.launchPeakHeight=60,this.layer="object",this.solid=!1,this.itemId=e.itemId,this.pickupRadius=e.pickupRadius??.6,this.transform.set(e.col,e.row),this.animController=new Q,this.animController.addAnimation("idle",{assetId:e.assetId,frameWidth:e.srcW,frameHeight:e.srcH,frameCount:e.frameCount??1,frameRate:e.frameRate??2,loop:!0}),this.animController.play("idle"),this.baseScale=e.drawH/e.srcH,this.drawScale=this.baseScale,this.blobShadow={rx:8,ry:4,opacity:.2}}update(t){switch(this.state){case"IDLE":this.bobTime+=t,this.transform.z=Math.sin(this.bobTime*2.5+this.bobPhase)*3;break;case"PICKING_UP":this.pickupT+=t/_t.PICKUP_DURATION,this.pickupT>=1?(this.pickupT=1,this.state="DONE",this.opacity=0):(this.drawScale=this.baseScale*(1+this.pickupT*.4),this.opacity=1-this.pickupT,this.transform.z=this.pickupT*20);break;case"LAUNCHING":{if(this.launchT+=t/this.launchDuration,this.launchT>=1)this.launchT=1,this.state="IDLE",this.transform.set(this.launchTo.x,this.launchTo.y),this.transform.z=0,this.drawScale=this.baseScale,this.opacity=1,this.blobShadow={rx:8,ry:4,opacity:.2},this.bobTime=0,this.bobPhase=Math.random()*Math.PI*2;else{const e=this.launchT,s=this.launchFrom.x+(this.launchTo.x-this.launchFrom.x)*e,i=this.launchFrom.y+(this.launchTo.y-this.launchFrom.y)*e;this.transform.set(s,i),this.transform.z=4*this.launchPeakHeight*e*(1-e),this.drawScale=this.baseScale*(1+.6*Math.sin(e*Math.PI)),this.opacity=1}break}}}startPickup(){return this.state!=="IDLE"?!1:(this.state="PICKING_UP",this.pickupT=0,this.blobShadow=null,!0)}startLaunch(t,e,s=.9,i=60){this.state="LAUNCHING",this.launchFrom={...t},this.launchTo={...e},this.launchDuration=s,this.launchPeakHeight=i,this.launchT=0,this.transform.set(t.x,t.y),this.opacity=0,this.blobShadow=null}isInRange(t,e){const s=t-this.transform.x,i=e-this.transform.y;return s*s+i*i<=this.pickupRadius*this.pickupRadius}};_t.PICKUP_DURATION=.35;let rt=_t;class ne extends et{constructor(t,e){super(t),this.inside=new Set,this.active=!0,this.layer="ground",this.solid=!1,this.opacity=0,this.transform.set(e.col,e.row),this.radius=e.radius,this.oneShot=e.oneShot??!1,this.onEnterCb=e.onEnter,this.onExitCb=e.onExit}check(t){if(!this.active)return;const e=this.transform.x,s=this.transform.y,i=this.radius*this.radius,o=new Set;for(const n of t){const r=n.x-e,l=n.y-s;r*r+l*l<=i&&o.add(n.id)}for(const n of o)if(!this.inside.has(n)&&(M.emit("trigger:enter",{zoneId:this.id,entityId:n}),this.onEnterCb?.(n),this.oneShot)){this.active=!1;return}for(const n of this.inside)o.has(n)||(M.emit("trigger:exit",{zoneId:this.id,entityId:n}),this.onExitCb?.(n));this.inside=o}deactivate(){this.active=!1,this.inside.clear()}reset(){this.active=!0,this.inside.clear()}}class Ns extends Gt{constructor(t,e,s){super(),this.isTransparent=!0,this.blocksUpdate=!0,this.item=t,this.ui=e,this.onClose=s}onEnter(){this.ui.show(this.item,()=>this.onClose())}onExit(){this.ui.hide()}update(t){}render(t){}}const Fs=c.CHAR_DRAW_H,at=class at{constructor(t,e,s,i,o){this.entityManager=t,this.camera=e,this.tileMap=s,this.stateManager=i,this.itemPreviewUI=o,this.floatingTexts=[],this.pendingEvents=[],this.onboardingHintActive=!0,this.onboardingFadeOut=0,this.dogNPC=null}addFloatingText(t,e,s,i=1,o=-30){const n=R(e,s),r=this.camera.worldToScreen(n.x,n.y);this.floatingTexts.push({text:t,x:r.x,y:r.y+o,life:i,maxLife:i})}updateFloatingTexts(t){for(let e=this.floatingTexts.length-1;e>=0;e--){const s=this.floatingTexts[e];s.life-=t,s.y-=30*t,s.life<=0&&this.floatingTexts.splice(e,1)}}drawFloatingTexts(t){t.save(),t.font="bold 14px monospace",t.textAlign="center";for(const e of this.floatingTexts){const s=Math.min(1,e.life/e.maxLife*2);t.fillStyle=`rgba(255, 240, 180, ${s})`,t.strokeStyle=`rgba(0, 0, 0, ${s*.7})`,t.lineWidth=2,t.strokeText(e.text,e.x,e.y),t.fillText(e.text,e.x,e.y)}t.restore()}updatePendingEvents(t){for(let e=this.pendingEvents.length-1;e>=0;e--)this.pendingEvents[e].timer-=t,this.pendingEvents[e].timer<=0&&(this.pendingEvents[e].callback(),this.pendingEvents.splice(e,1))}updateOnboarding(t,e){this.onboardingHintActive?e&&(e.vx!==0||e.vy!==0)&&(this.onboardingHintActive=!1,this.onboardingFadeOut=at.ONBOARDING_FADE_DURATION):this.onboardingFadeOut>0&&(this.onboardingFadeOut-=t)}drawOnboardingHint(t,e,s,i,o){let n;if(this.onboardingHintActive)n=Math.min(1,s*2);else if(this.onboardingFadeOut>0)n=this.onboardingFadeOut/at.ONBOARDING_FADE_DURATION;else return;const r=R(i,o),l=e.worldToScreen(r.x,r.y),h=l.x,d=l.y-Fs*.8*e.zoom,u=Math.sin(s*2.5)*3;t.save(),t.globalAlpha=n*.9,t.font="12px monospace",t.textAlign="center";const g="нажми ←↑↓→",y="для движения",f=16,m=14,v=8,I=t.measureText(g).width,_=t.measureText(y).width,p=Math.max(I,_)+m*2,T=f*2+v*2,w=h-p/2,S=d+u-v-f;t.fillStyle="rgba(0, 0, 0, 0.45)";const E=6;t.beginPath(),t.moveTo(w+E,S),t.lineTo(w+p-E,S),t.quadraticCurveTo(w+p,S,w+p,S+E),t.lineTo(w+p,S+T-E),t.quadraticCurveTo(w+p,S+T,w+p-E,S+T),t.lineTo(w+E,S+T),t.quadraticCurveTo(w,S+T,w,S+T-E),t.lineTo(w,S+E),t.quadraticCurveTo(w,S,w+E,S),t.closePath(),t.fill(),t.fillStyle="#e8dcc0",t.strokeStyle="rgba(0, 0, 0, 0.7)",t.lineWidth=3,t.strokeText(g,h,d+u),t.fillText(g,h,d+u),t.strokeText(y,h,d+u+f),t.fillText(y,h,d+u+f),t.restore()}updateCollectibles(t,e,s){for(const i of this.entityManager.getAll())if(i instanceof rt){if(i.update(t),i.state===Ot.IDLE&&i.isInRange(e,s)&&i.startPickup()&&B.add(i.itemId,1,i.id)>0){M.emit("collectible:pickup",{collectibleId:i.id,itemId:i.itemId}),this.addFloatingText("+1",i.transform.x,i.transform.y);const n=lt(i.itemId);n&&!n.stackable&&this.showItemPreview(n)}i.state===Ot.DONE&&this.entityManager.remove(i.id)}}showItemPreview(t){const e=new Ns(t,this.itemPreviewUI,()=>{this.stateManager.pop()});this.stateManager.push(e)}updateTriggerZones(){const t=this.entityManager.getAll().filter(e=>!(e instanceof ne)).map(e=>({id:e.id,x:e.transform.x,y:e.transform.y}));for(const e of this.entityManager.getAll())e instanceof ne&&e.check(t)}updateCampfireInteractable(t,e){const s=B.has("stick",2),i=U.isActive("q_gather_sticks"),o=J.getBool("sticks_in_fire");s&&i&&!o&&e?(t.interactable=!0,t.interactLabel="подкинуть дрова"):(t.interactable=!1,t.interactLabel="")}interactWithCampfire(t){B.has("stick",2)&&(B.remove("stick",2),J.set("sticks_in_fire",!0),U.checkFlags(),t.interactable=!1,t.feed(),this.addFloatingText("Как вспыхнул!",c.CAMPFIRE_COL,c.CAMPFIRE_ROW,1.5,-40),t.burst(2.5),this.pendingEvents.push({timer:1.5,callback:()=>this.spawnSecretItem()}))}spawnSecretItem(){let e=c.CAMPFIRE_COL,s=c.CAMPFIRE_ROW;for(let o=0;o<20;o++){const n=Math.random()*Math.PI*2,r=1+Math.random()*1,l=Math.max(.5,Math.min(this.tileMap.cols-.5,c.CAMPFIRE_COL+Math.cos(n)*r)),h=Math.max(.5,Math.min(this.tileMap.rows-.5,c.CAMPFIRE_ROW+Math.sin(n)*r));if(this.tileMap.isTileWalkable(Math.floor(l),Math.floor(h))&&!this.tileMap.collidesWithObject(l,h,.15,.15)){e=l,s=h;break}}const i=new rt("secret_pink_lighter",{col:c.CAMPFIRE_COL,row:c.CAMPFIRE_ROW,pickupRadius:.33,itemId:"pink_lighter",assetId:"item_pink_lighter_world",srcW:43,srcH:87,drawH:26});i.glowEffect={radius:28,r:230,g:140,b:180,opacity:.25},i.startLaunch({x:c.CAMPFIRE_COL,y:c.CAMPFIRE_ROW},{x:e,y:s},.9,100),this.entityManager.add(i),this.addFloatingText("✨ Вжух!",c.CAMPFIRE_COL,c.CAMPFIRE_ROW,2,-60)}drawCampfireSparks(t,e,s,i){const o=s.sparks;if(o.length===0)return;const n=e.zoom,r=R(c.CAMPFIRE_COL,c.CAMPFIRE_ROW),l=e.worldToScreen(r.x,r.y),h=l.y+c.TILE_HEIGHT/2*n;t.save();for(const d of o){const u=d.life/d.maxLife,g=Math.min(1,u*1.2)*i,y=d.radius*n*Math.max(.4,u),f=l.x+d.ox*n,m=h+d.oy*n,v=255,I=Math.floor(110+d.hue*145),_=Math.floor(d.hue*60),p=y*3;t.globalAlpha=g*.3;const T=t.createRadialGradient(f,m,0,f,m,p);T.addColorStop(0,`rgba(${v},${I},${_},0.6)`),T.addColorStop(1,`rgba(${v},${I},0,0)`),t.fillStyle=T,t.fillRect(f-p,m-p,p*2,p*2),t.globalAlpha=g,t.fillStyle=`rgb(${v},${I},${_})`,t.fillRect(Math.floor(f-y/2),Math.floor(m-y/2),Math.ceil(y),Math.ceil(y))}t.globalAlpha=1,t.restore()}drawDogZzz(t,e,s){const i=this.dogNPC;if(!i||i.npcState!==Dt.SLEEPING)return;const o=R(i.transform.x,i.transform.y),n=e.worldToScreen(o.x,o.y),r=e.zoom;t.save(),t.textAlign="center";const l=[{delay:0,size:11,dx:6,rise:35},{delay:.7,size:14,dx:14,rise:50},{delay:1.4,size:18,dx:22,rise:65}],h=2.8;for(const d of l){const g=((s-d.delay)%h+h)%h/h,y=g<.15?g/.15:g>.7?1-(g-.7)/.3:1;if(y<=0)continue;const f=n.y+c.DOG_DRAW_H*.1*r,m=n.x+d.dx*r,v=f-d.rise*g*r;t.globalAlpha=y*.75,t.font=`bold ${Math.round(d.size*.8*r)}px monospace`,t.fillStyle="#e8dcc0",t.strokeStyle="rgba(0,0,0,0.6)",t.lineWidth=2.5,t.strokeText("z",m,v),t.fillText("z",m,v)}t.restore()}};at.ONBOARDING_FADE_DURATION=.6;let Lt=at;const ae=c.TILE_IMG_W,re=c.TILE_IMG_H,Us=c.CHAR_SRC_W,Bs=c.CHAR_SRC_H,it=c.CHAR_DRAW_H,qs=it/Bs,Et=Us*qs;class js{constructor(t){this.renderer=t.renderer,this.postProcess=t.postProcess,this.camera=t.camera,this.tileMap=t.tileMap,this.entityManager=t.entityManager,this.inputManager=t.inputManager,this.player=t.player,this.campfire=t.campfire,this.campfireFlicker=t.campfireFlicker,this.stateManager=t.stateManager,this.markerCanvas=t.markerCanvas,this.markerCtx=t.markerCtx,this.gameplaySystem=t.gameplaySystem,this.markerIsEmoji=t.isTouch,this.markerLabel=t.isTouch?"🤚":"E"}render(t,e){const{elapsed:s,activeProfile:i,snowEnabled:o,nearestInteractId:n}=e,r=this.camera,l=r.zoom;this.renderer.clear();for(let h=0;h<this.tileMap.rows;h++)for(let d=0;d<this.tileMap.cols;d++){const u=this.tileMap.getTileDef(d,h);u&&this.renderer.enqueueTile(d,h,u.assetId,ae,re,ae,re)}for(const h of this.tileMap.objects)this.renderer.enqueueObject(h.col,h.row,h.assetId,h.width,h.height,h.anchorY,h.srcW,h.srcH,h.groundLayer?st.GROUND:st.OBJECT,(h.rotation??0)*Math.PI/180,h.depthBias??0);for(const h of this.entityManager.getAll())this.renderer.enqueueEntity(h);this.renderer.flushLayer(st.GROUND),this.renderer.drawBoundaryVignette(this.tileMap.cols,this.tileMap.rows,"back"),this.renderer.drawAnimatedEdgeFog(this.tileMap.cols,this.tileMap.rows,s,"back");for(const h of this.entityManager.getAll()){const d=h.blobShadow;if(!d)continue;const u=R(h.transform.x,h.transform.y);this.renderer.drawBlobShadow(u.x,u.y,d.rx,d.ry,d.opacity*h.opacity)}for(const h of this.entityManager.getAll()){const d=h.glowEffect;if(!d)continue;const u=R(h.transform.x,h.transform.y);this.renderer.drawGlow(u.x,u.y,h.transform.z,d.radius,d.r,d.g,d.b,d.opacity*h.opacity)}i.fireOpacity>.001&&this.gameplaySystem.drawCampfireSparks(this.renderer.ctx,r,this.campfire,i.fireOpacity),this.renderer.flushLayer(st.OBJECT),this.renderer.drawBoundaryVignette(this.tileMap.cols,this.tileMap.rows,"front"),this.renderer.drawAnimatedEdgeFog(this.tileMap.cols,this.tileMap.rows,s,"front"),o&&this.renderer.drawSnow(this.tileMap.cols,this.tileMap.rows,t,s),this.gameplaySystem.drawFloatingTexts(this.renderer.ctx),this.gameplaySystem.drawDogZzz(this.renderer.ctx,r,s),this.gameplaySystem.drawOnboardingHint(this.renderer.ctx,r,s,this.player.transform.x,this.player.transform.y),this.inputManager.isActionDown(W.DEBUG_GRID)&&this.renderer.drawGridOverlay(this.tileMap.cols,this.tileMap.rows),this.postProcess.enabled&&(this.postProcess.clearLights(),this.postProcess.clearOccluders(),this.postProcess.clearHeightFade(),this.setupLights(t,i,l,r),this.setupOccluders(i,l,r),this.setupVolumetric(i,l,r),this.postProcess.render(t)),this.drawInteractMarkers(s,n)}setupLights(t,e,s,i){const o=R(this.tileMap.cols/2,this.tileMap.rows/2),n=o.x+e.skyLightOffsetX,r=o.y+e.skyLightOffsetY,l=i.worldToScreen(n,r);if(this.postProcess.addLight({x:l.x,y:l.y,radius:e.skyLightRadius*s,r:e.skyLightR,g:e.skyLightG,b:e.skyLightB,intensity:e.skyLightIntensity,flicker:0}),e.pointLightOpacity>.001){const h=R(c.WINDOW_LIGHT_COL,c.WINDOW_LIGHT_ROW),d=i.worldToScreen(h.x,h.y+c.TILE_HEIGHT/2-c.WINDOW_LIGHT_HEIGHT);this.postProcess.addLight({x:d.x,y:d.y,radius:c.WINDOW_LIGHT_RADIUS*s,r:c.WINDOW_LIGHT_R,g:c.WINDOW_LIGHT_G,b:c.WINDOW_LIGHT_B,intensity:c.WINDOW_LIGHT_INTENSITY*e.pointLightOpacity,flicker:c.WINDOW_LIGHT_FLICKER})}if(e.pointLightOpacity>.001){const h=R(c.WINDOW2_LIGHT_COL,c.WINDOW2_LIGHT_ROW),d=i.worldToScreen(h.x,h.y+c.TILE_HEIGHT/2-c.WINDOW2_LIGHT_HEIGHT);this.postProcess.addLight({x:d.x,y:d.y,radius:c.WINDOW2_LIGHT_RADIUS*s,r:c.WINDOW2_LIGHT_R,g:c.WINDOW2_LIGHT_G,b:c.WINDOW2_LIGHT_B,intensity:c.WINDOW2_LIGHT_INTENSITY*e.pointLightOpacity,flicker:c.WINDOW2_LIGHT_FLICKER})}if(e.pointLightOpacity>.001&&B.has("pink_lighter")){const h=R(c.DOOR_LIGHT_COL,c.DOOR_LIGHT_ROW),d=i.worldToScreen(h.x,h.y+c.TILE_HEIGHT/2-c.DOOR_LIGHT_HEIGHT);this.postProcess.addLight({x:d.x,y:d.y,radius:c.DOOR_LIGHT_RADIUS*s,r:c.DOOR_LIGHT_R,g:c.DOOR_LIGHT_G,b:c.DOOR_LIGHT_B,intensity:c.DOOR_LIGHT_INTENSITY*e.pointLightOpacity,flicker:c.DOOR_LIGHT_FLICKER})}if(e.fireOpacity>.001){this.campfireFlicker.update(t);const h=R(c.CAMPFIRE_COL,c.CAMPFIRE_ROW),d=i.worldToScreen(h.x,h.y+c.TILE_HEIGHT/2-c.CAMPFIRE_LIGHT_HEIGHT),u=this.campfire.lightMult;this.postProcess.addLight({x:d.x,y:d.y,radius:c.CAMPFIRE_LIGHT_RADIUS*s*this.campfireFlicker.radius*u,r:this.campfireFlicker.r,g:this.campfireFlicker.g,b:this.campfireFlicker.b,intensity:c.CAMPFIRE_LIGHT_INTENSITY*this.campfireFlicker.intensity*e.fireOpacity*u,flicker:0})}}setupOccluders(t,e,s){for(const f of this.tileMap.objects){const m=(f.shadowHeight??f.height)*e;if(f.shadowPoints)for(const v of f.shadowPoints){const I=R(f.col+v.dx,f.row+v.dy),_=s.worldToScreen(I.x,I.y+c.TILE_HEIGHT/2);this.postProcess.addOccluder({x:_.x,y:_.y,radius:v.radius*e,height:m})}else{const v=f.shadowRadius??f.width*.15;if(v<=0)continue;const I=R(f.col,f.row),_=s.worldToScreen(I.x,I.y+c.TILE_HEIGHT/2);this.postProcess.addOccluder({x:_.x,y:_.y,radius:v*e,height:m})}}const i=R(this.player.transform.x,this.player.transform.y),o=s.worldToScreen(i.x,i.y),n=c.PLAYER_FOOT_OFFSET*e,r=o.y+c.TILE_HEIGHT/2*e-n,l=c.PLAYER_SHADOW_RADIUS*e,h=it*e;this.postProcess.addOccluder({x:o.x,y:r,radius:l,height:h});const d=l*.7,u=l*.7;this.postProcess.addOccluder({x:o.x-d,y:r,radius:u,height:h*.8}),this.postProcess.addOccluder({x:o.x+d,y:r,radius:u,height:h*.8});for(const f of this.entityManager.getAll()){if(!(f instanceof It)||f.opacity<=0)continue;const m=R(f.transform.x,f.transform.y),v=s.worldToScreen(m.x,m.y),I=c.DOG_FOOT_OFFSET*e,_=v.y+c.TILE_HEIGHT/2*e-I,p=c.DOG_SHADOW_RADIUS*e,T=f.animController?.getCurrentFrame(),w=(T?.height??c.DOG_DRAW_H)*f.drawScale*e;this.postProcess.addOccluder({x:v.x,y:_,radius:p,height:w});const S=(T?.width??c.DOG_IDLE_SRC_W)*f.drawScale*e;this.postProcess.addHeightFade(v.x,_,S,w,c.SHADOW_HEIGHT_FADE*.7)}const g=it*e,y=Et*e;this.postProcess.addHeightFade(o.x,r,y,g,c.SHADOW_HEIGHT_FADE,!0)}setupVolumetric(t,e,s){const i=R(this.player.transform.x,this.player.transform.y),o=s.worldToScreen(i.x,i.y),n=this.player.animController,r=n.getCurrentFrame(),l=n.getCurrentAssetId(),h=b.get(l),d=b.getSize(l);if(h&&d){const u=o.x-Et/2*e,g=o.y+(-it+c.TILE_HEIGHT/2)*e,y=Et*e,f=it*e,m=r.x/d.width,v=1-(r.y+r.height)/d.height,I=r.width/d.width,_=r.height/d.height;this.postProcess.setVolumetricSprite(h,u,g,y,f,m,v,I,_),this.postProcess.setVolumetricParams(c.VOLUMETRIC_DIFFUSE,c.VOLUMETRIC_RIM,t.volRimR,t.volRimG,t.volRimB)}}drawInteractMarkers(t,e){const s=this.markerCtx;if(s.clearRect(0,0,this.markerCanvas.width,this.markerCanvas.height),this.stateManager.size>1)return;const i=this.camera,o=i.zoom,n=b.get("interact_marker"),r=this.player.animController,l=this.player.transform,h=l.x+l.y;let d=null;if(r){const y=R(l.x,l.y),f=i.worldToScreen(y.x,y.y),m=r.getCurrentFrame(),v=b.get(r.getCurrentAssetId());if(v){const I=this.player.drawScale,_=m.width*I,p=m.height*I;d={asset:v,sx:m.x,sy:m.y,sw:m.width,sh:m.height,dx:f.x+-_/2*o,dy:f.y+(-p+c.TILE_HEIGHT/2-l.z)*o,dw:_*o,dh:p*o}}}const u=[],g=[];for(const y of this.entityManager.getAll()){if(!y.interactable)continue;const f=y.transform.x+y.transform.y;d&&h>f?u.push(y):g.push(y)}for(const y of u)this.drawSingleMarker(s,y,i,o,n??null,t,e);u.length>0&&d&&(s.save(),s.globalCompositeOperation="destination-out",s.drawImage(d.asset,d.sx,d.sy,d.sw,d.sh,d.dx,d.dy,d.dw,d.dh),s.restore());for(const y of g)this.drawSingleMarker(s,y,i,o,n??null,t,e)}drawSingleMarker(t,e,s,i,o,n,r){const l=R(e.transform.x,e.transform.y),h=s.worldToScreen(l.x,l.y),d=(e.animController?.getCurrentFrame()?.height??0)*e.drawScale,u=e instanceof tt?e.markerOffsetY*i:0,g=d>0?(-d+c.TILE_HEIGHT/2)*i:-30*i-u,y=Math.sin(n*3)*3,f=Math.min(1.6,Math.max(.6,i*.8)),m=14*f,v=10*f,I=h.y+g-8+y,_=h.x-m/2;if(o&&(t.save(),t.shadowColor="rgba(209, 165, 136, 1)",t.shadowBlur=5*f,t.shadowOffsetY=1,t.drawImage(o,0,0,7,5,_,I,m,v),t.restore()),r===e.id){const p=.65+.35*(.5+.5*Math.cos(n*Math.PI));t.save(),t.globalAlpha=p;const T=this.markerLabel,w=11;t.font=`bold ${w}px monospace`;const S=t.measureText(T),E=6,O=4,H=(S.actualBoundingBoxAscent??w*.8)+(S.actualBoundingBoxDescent??w*.2),D=Math.max(S.width,H)+E*2,$=H+O*2,C=h.x-D/2,X=4*f,k=I-X-$;t.fillStyle="rgba(8, 10, 18, 0.72)";const j=3;t.beginPath(),t.moveTo(C+j,k),t.lineTo(C+D-j,k),t.quadraticCurveTo(C+D,k,C+D,k+j),t.lineTo(C+D,k+$-j),t.quadraticCurveTo(C+D,k+$,C+D-j,k+$),t.lineTo(C+j,k+$),t.quadraticCurveTo(C,k+$,C,k+$-j),t.lineTo(C,k+j),t.quadraticCurveTo(C,k,C+j,k),t.closePath(),t.fill(),t.strokeStyle="rgba(200, 170, 100, 0.3)",t.lineWidth=1,t.stroke(),t.fillStyle="rgba(240, 232, 192, 0.85)",t.textAlign="center",t.textBaseline="middle",t.shadowColor="rgba(0,0,0,0.9)",t.shadowBlur=2,t.shadowOffsetY=1,this.markerIsEmoji&&(t.shadowColor="transparent",t.filter="brightness(0) invert(1)"),t.fillText(T,h.x,k+$/2),this.markerIsEmoji&&(t.filter="none"),t.restore()}}}const ye=["south","north","east","west","south_east","south_west","north_east","north_west"],pt=c.CHAR_SRC_W,Ct=c.CHAR_SRC_H,$s=c.CHAR_DRAW_H,Ys=$s/Ct;function K(a,t){const e=b.getSize(a);return e?Math.max(1,Math.floor(e.width/t)):1}function Vs(a){const t=b.has("char_idle");for(const e of ye)if(t){const s="char_idle",i={assetId:s,frameWidth:pt,frameHeight:Ct,frameCount:K(s,pt),frameRate:1,loop:!0};a.animController.addAnimation(`idle_${e}`,i);const o=`char_walk_${e}`,n=b.has(o)?o:s,r={assetId:n,frameWidth:pt,frameHeight:Ct,frameCount:K(n,pt),frameRate:5,loop:!0};a.animController.addAnimation(`walk_${e}`,r)}else{const s=e.includes("_")?e.split("_")[0]:e,i=`char_walk_${s}`,o=`char_idle_${s}`;a.animController.addAnimation(`walk_${e}`,{assetId:i,frameWidth:32,frameHeight:48,frameCount:K(i,32),frameRate:8,loop:!0}),a.animController.addAnimation(`idle_${e}`,{assetId:o,frameWidth:32,frameHeight:48,frameCount:K(o,32),frameRate:1,loop:!0})}}function Xs(a){const t=new ue;return t.drawScale=Ys,t.transform.set(c.PLAYER_START_COL,c.PLAYER_START_ROW),Vs(t),t.animController.play("idle_south"),a.add(t),t}function zs(a){const t=new gt(c.CAMPFIRE_COL,c.CAMPFIRE_ROW);return t.setBaseScale(c.CAMPFIRE_DRAW_H/Mt),t.blobShadow={rx:12,ry:6,opacity:.18},t.animController.addAnimation("burn",{assetId:"campfire_anim",frameWidth:le,frameHeight:Mt,frameCount:ce,frameRate:6,loop:!0}),t.animController.play("burn"),a.add(t),t}function Ks(a){const t=new It("dog",{spawnCol:c.DOG_SPAWN_COL,spawnRow:c.DOG_SPAWN_ROW,targetCol:c.DOG_TARGET_COL,targetRow:c.DOG_TARGET_ROW,speed:c.DOG_SPEED,fadeDuration:c.DOG_FADE_DURATION,dialogId:"dog_greeting"});t.drawScale=c.DOG_DRAW_H/c.DOG_IDLE_SRC_H,t.blobShadow={rx:11,ry:6,opacity:.3};const e="dog_walk_west",s="dog_idle";for(const o of ye)b.has(e)&&t.animController.addAnimation(`walk_${o}`,{assetId:e,frameWidth:c.DOG_WALK_SRC_W,frameHeight:c.DOG_WALK_SRC_H,frameCount:K(e,c.DOG_WALK_SRC_W),frameRate:6,loop:!0}),b.has(s)&&t.animController.addAnimation(`idle_${o}`,{assetId:s,frameWidth:c.DOG_IDLE_SRC_W,frameHeight:c.DOG_IDLE_SRC_H,frameCount:K(s,c.DOG_IDLE_SRC_W),frameRate:2,loop:!0});const i="dog_sleeping";return b.has(i)&&t.animController.addAnimation("sleep",{assetId:i,frameWidth:c.DOG_SLEEP_SRC_W,frameHeight:c.DOG_SLEEP_SRC_H,frameCount:K(i,c.DOG_SLEEP_SRC_W),frameRate:2,loop:!0}),t.animController.play("walk_south_west"),a.add(t),M.on("dialog:close",()=>{U.isCompleted("q_dog_bone")&&t.npcState!==Dt.SLEEPING&&t.sleep()}),t}function Zs(a){const t=[{id:"collect_bone_1",itemId:"bone",col:4.4,row:4.1,assetId:"item_bone_world",srcW:32,srcH:32,drawH:24,pickupRadius:.4},{id:"collect_bone_2",itemId:"bone",col:1.2,row:4.4,assetId:"item_bone_world",srcW:32,srcH:32,drawH:24,pickupRadius:.4},{id:"collect_stone_1",itemId:"stone",col:5,row:2,assetId:"item_stone_world",srcW:32,srcH:32,drawH:20}];for(const e of t){const s=new rt(e.id,{col:e.col,row:e.row,itemId:e.itemId,assetId:e.assetId,srcW:e.srcW,srcH:e.srcH,drawH:e.drawH,pickupRadius:e.pickupRadius});a.add(s)}}function Qs(a,t,e){const s=[{entityId:"interact_stick_pile_1",tileObjId:"stick_pile_1",col:.5,row:3.1},{entityId:"interact_stick_pile_2",tileObjId:"stick_pile_2",col:2.8,row:2.2}];for(const i of s){const o=new tt(i.entityId,{col:i.col,row:i.row,label:"собрать хворост",onInteract:()=>B.add("stick",1,i.entityId)>0?(M.emit("collectible:pickup",{collectibleId:i.entityId,itemId:"stick"}),e.addFloatingText("+1 Хворост",i.col,i.row,1.2),t.removeObjectById(i.tileObjId),o.deplete(),a.remove(i.entityId),!0):!1});a.add(o)}}function Js(a){const t=new tt("interact_door",{col:1.1,row:2.3,label:"дверь",onInteract:()=>(M.emit("dialog:request",{dialogId:"door_mystery"}),!0),radius:.6,markerOffsetY:40});t.interactable=B.has("pink_lighter"),M.on("inventory:changed",()=>{t.interactable=B.has("pink_lighter")&&!t.depleted}),a.add(t)}function ti(a,t){const e=new tt("interact_wall_note",{col:2,row:2.65,label:"прочитать записку",onInteract:()=>(t.show(()=>{t.hide()}),!0),radius:.6,markerOffsetY:50});a.add(e)}const vt=class vt{constructor(t,e){this.touchProvider=null,this.lastTimestamp=0,this.elapsed=0,this.running=!1,this.idleTimer=0,this.isIdle=!1,this.lightTogglePrev=!1,this.snowTogglePrev=!1,this.snowEnabled=!0,this.inventoryTogglePrev=!1,this.questLogTogglePrev=!1,this.controlsHelpTogglePrev=!1,this.debugTogglePrev=!1,this.questHudTogglePrev=!1,this.timeTogglePrev=!1,this.isNight=!0,this.activeProfile={...z},this.targetProfile=z,this.profileLerpT=1,this.loop=u=>{if(!this.running)return;const g=Math.min((u-this.lastTimestamp)/1e3,.1);this.lastTimestamp=u,this.stateManager.update(g),this.stateManager.render(g),requestAnimationFrame(this.loop)},this.tileMap=e,this.camera=new ts,this.renderer=new ns(t,this.camera),this.postProcess=new ls(t,this.renderer.canvas),this.postProcess.enabled=c.LIGHTING_ENABLED;const s=document.createElement("canvas");Object.assign(s.style,{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none",zIndex:"2",imageRendering:"pixelated"}),t.appendChild(s);const i=s.getContext("2d");i.imageSmoothingEnabled=!1;const o=()=>{s.width=window.innerWidth,s.height=window.innerHeight,i.imageSmoothingEnabled=!1};o(),window.addEventListener("resize",o),this.postProcess.setAmbient(z.ambientR,z.ambientG,z.ambientB);const n=[],r="ontouchstart"in window||navigator.maxTouchPoints>0,l=matchMedia("(pointer: fine)").matches;(!r||l)&&n.push(new ds(this.renderer.canvas,this.camera)),r&&(this.touchProvider=new gs(t),n.push(this.touchProvider)),this.inputManager=new hs(n),this.physics=new ms(e),this.animationSystem=new _s,this.entityManager=new Ps,this.hud=new Rs,this.dialogUI=new xt,this.inventoryUI=new Es,this.questLogUI=new Ms,this.controlsHelpUI=new xs,this.itemPreviewUI=new Os,this.noteUI=new At;const h=document.getElementById("interact-prompt");document.getElementById("inv-preview")?.addEventListener("click",u=>{if(u.target.closest(".inv-preview-questlog")){this.questLogUI.visible?this.questLogUI.hide():(this.inventoryUI.hide(),this.controlsHelpUI.hide(),this.questLogUI.show());return}!this.inventoryUI.visible&&!this.itemPreviewUI.visible&&!this.noteUI.visible&&this.openInventory()}),this.stateManager=new As,this.interactionSystem=new Ws(this.entityManager,this.inputManager,h),this.gameplaySystem=new Lt(this.entityManager,this.camera,this.tileMap,this.stateManager,this.itemPreviewUI),this.touchProvider&&(this.gameplaySystem.onboardingHintActive=!1),this.player=Xs(this.entityManager),this.campfire=zs(this.entityManager),this.campfireFlicker=new Hs({baseR:c.CAMPFIRE_LIGHT_R,baseG:c.CAMPFIRE_LIGHT_G,baseB:c.CAMPFIRE_LIGHT_B}),this.gameplaySystem.pendingEvents.push({timer:c.DOG_SPAWN_DELAY,callback:()=>{const u=Ks(this.entityManager);this.gameplaySystem.dogNPC=u}}),Zs(this.entityManager),Qs(this.entityManager,this.tileMap,this.gameplaySystem),Js(this.entityManager),ti(this.entityManager,this.noteUI),M.on("dialog:request",({dialogId:u})=>{const g=ie(u);if(!g)return;this.interactionSystem.hidePrompt();const y=new se(g,this.dialogUI,()=>{this.stateManager.pop()});this.stateManager.push(y)}),M.on("door:reveal",()=>{this.noteUI.show(()=>{this.noteUI.hide()},`<div class="note-title">🚪</div>
         <div class="note-body">
           <p>Что находится за этой дверью? Вы узнаете чуть позже, она в разработке. Предлагаю относиться к этому, как к сериалу: в каждой серии будет что-то новенькое, но не всё сразу!</p>
           <p><strong>Продолжение следует...</strong></p>
         </div>
         <div class="note-hint">
           <span class="keyboard-hint">Нажмите <span class="key">Enter</span> или <span class="key">ESC</span> чтобы закрыть</span>
           <span class="touch-hint">Нажмите чтобы закрыть</span>
         </div>`)}),U.init(),U.start("q_gather_sticks"),this.renderOrchestrator=new js({renderer:this.renderer,postProcess:this.postProcess,camera:this.camera,tileMap:this.tileMap,entityManager:this.entityManager,inputManager:this.inputManager,player:this.player,campfire:this.campfire,campfireFlicker:this.campfireFlicker,stateManager:this.stateManager,markerCanvas:s,markerCtx:i,gameplaySystem:this.gameplaySystem,isTouch:this.touchProvider!==null}),this.stateManager.push(new Gs(this));const d=R(this.player.transform.x,this.player.transform.y);this.camera.follow(d.x,d.y),this.camera.snap()}start(){this.running=!0;const t=document.getElementById("loading");t&&(t.style.display="none"),this.lastTimestamp=performance.now(),requestAnimationFrame(this.loop)}stop(){this.running=!1}_update(t){!this.inventoryUI.visible&&!this.itemPreviewUI.visible&&!this.noteUI.visible?this.player.handleInput(this.inputManager):this.player.velocity&&(this.player.velocity.vx=0,this.player.velocity.vy=0);const e=this.entityManager.getAll();this.gameplaySystem.updateOnboarding(t,this.player.velocity),this.physics.update(t,e);for(const o of e)o instanceof It&&o.update(t);this.activeProfile.fireOpacity>.001&&this.campfire.updateSparks(t),this.animationSystem.update(t,e);const s=R(this.player.transform.x,this.player.transform.y);this.camera.follow(s.x,s.y),this.camera.update(t),M.emit("player:moved",{x:this.player.transform.x,y:this.player.transform.y}),this.gameplaySystem.updateCampfireInteractable(this.campfire,this.isNight);const i=this.interactionSystem.update(this.player.transform.x,this.player.transform.y);if(this.touchProvider){const o=this.interactionSystem.nearestInteractLabel;this.touchProvider.setInteractVisible(o!==null,o??void 0)}if(i)switch(i.type){case"npc":this.openDialog(i.entity);break;case"interactable":i.entity.interact();break;case"campfire":this.gameplaySystem.interactWithCampfire(this.campfire);break}this.gameplaySystem.updatePendingEvents(t),this.gameplaySystem.updateCollectibles(t,this.player.transform.x,this.player.transform.y),this.gameplaySystem.updateTriggerZones(),this.gameplaySystem.updateFloatingTexts(t),this.hud.update(t,this.player,this.camera,this.tileMap),this.touchProvider&&this.updateIdleZoom(t)}updateIdleZoom(t){const e=this.player.velocity;if(e&&(Math.abs(e.vx)>.001||Math.abs(e.vy)>.001)){this.idleTimer=0,this.isIdle&&(this.isIdle=!1,this.camera.setTargetZoom(c.CAMERA_DEFAULT_ZOOM),this.hud.setIdleMode(!1),this.touchProvider.setInteractVisible(!1));return}this.isIdle||(this.idleTimer+=t,this.idleTimer>=c.CAMERA_IDLE_DELAY&&(this.isIdle=!0,this.camera.setTargetZoom(c.CAMERA_IDLE_ZOOM),this.hud.setIdleMode(!0)))}_render(t){this.elapsed+=t,this.handleInputToggles(),this.updateProfileTransition(t),this.applyLightingProfile(),this.renderOrchestrator.render(t,{elapsed:this.elapsed,activeProfile:this.activeProfile,snowEnabled:this.snowEnabled,nearestInteractId:this.interactionSystem.nearestInteractId})}handleInputToggles(){const t=this.inputManager.isActionDown(W.TOGGLE_LIGHT);t&&!this.lightTogglePrev&&(this.postProcess.enabled=!this.postProcess.enabled),this.lightTogglePrev=t;const e=this.inputManager.isActionDown(W.TOGGLE_SNOW);e&&!this.snowTogglePrev&&(this.snowEnabled=!this.snowEnabled),this.snowTogglePrev=e;const s=this.inputManager.isActionDown(W.INVENTORY);s&&!this.inventoryTogglePrev&&!this.inventoryUI.visible&&!this.itemPreviewUI.visible&&!this.noteUI.visible&&(this.questLogUI.hide(),this.controlsHelpUI.hide(),this.openInventory()),this.inventoryTogglePrev=s;const i=this.inputManager.isActionDown(W.QUEST_LOG);i&&!this.questLogTogglePrev&&(this.questLogUI.visible?this.questLogUI.hide():(this.inventoryUI.hide(),this.controlsHelpUI.hide(),this.questLogUI.show())),this.questLogTogglePrev=i;const o=this.inputManager.isActionDown(W.CONTROLS_HELP);o&&!this.controlsHelpTogglePrev&&(this.controlsHelpUI.visible?this.controlsHelpUI.hide():(this.inventoryUI.hide(),this.questLogUI.hide(),this.controlsHelpUI.show())),this.controlsHelpTogglePrev=o,this.inputManager.isActionDown(W.PAUSE)&&(this.noteUI.visible?this.noteUI.hide():this.itemPreviewUI.visible?this.itemPreviewUI.hide():this.inventoryUI.visible?this.inventoryUI.hide():this.questLogUI.visible?this.questLogUI.hide():this.controlsHelpUI.visible&&this.controlsHelpUI.hide());const r=this.inputManager.isActionDown(W.TOGGLE_DEBUG);r&&!this.debugTogglePrev&&this.hud.setDebugVisible(!this.hud.debugVisible),this.debugTogglePrev=r;const l=this.inputManager.isActionDown(W.TOGGLE_QUEST_HUD);l&&!this.questHudTogglePrev&&this.hud.setQuestHudVisible(!this.hud.questHudVisible),this.questHudTogglePrev=l}updateProfileTransition(t){const e=this.inputManager.isActionDown(W.TOGGLE_TIME);if(e&&!this.timeTogglePrev&&(this.isNight=!this.isNight,this.targetProfile=this.isNight?z:oe,this.profileLerpT=0),this.timeTogglePrev=e,this.profileLerpT<1){this.profileLerpT=Math.min(1,this.profileLerpT+t/vt.PROFILE_TRANSITION_SPEED);const s=this.profileLerpT<.5?2*this.profileLerpT*this.profileLerpT:1-Math.pow(-2*this.profileLerpT+2,2)/2,i=this.isNight?oe:z;this.activeProfile=Ds(i,this.targetProfile,s)}}applyLightingProfile(){const t=this.activeProfile,e=(s,i,o)=>"#"+[s,i,o].map(n=>Math.round(n*255).toString(16).padStart(2,"0")).join("");this.renderer.setBackgroundColor(e(t.bgR,t.bgG,t.bgB)),this.postProcess.setAmbient(t.ambientR,t.ambientG,t.ambientB),this.postProcess.setShadowLengthMult(t.shadowLengthMult),this.postProcess.setShadowOpacity(t.shadowOpacity),this.campfire.opacity=t.fireOpacity,this.renderer.applyEffectProfile(t)}openInventory(){this.inventoryUI.show(t=>{const e=lt(t);e&&(this.inventoryUI.hide(),this.itemPreviewUI.show(e,()=>{this.itemPreviewUI.hide(),this.openInventory()},{showLabel:!1}))},()=>{this.inventoryUI.hide()})}openDialog(t){const e=ie(t.dialogId);if(!e)return;this.interactionSystem.hidePrompt();const s=new se(e,this.dialogUI,()=>{this.stateManager.pop()});this.stateManager.push(s)}};vt.PROFILE_TRANSITION_SPEED=1.5;let Pt=vt;async function ei(){console.log("[Perun] Booting..."),Ze();try{const s=await Oe();s.length>0?(await b.loadAll(s),console.log(`[Perun] ${s.length} PNG assets loaded from manifest.`)):console.warn("[Perun] Asset manifest was empty — using procedural fallbacks.")}catch(s){console.warn("[Perun] Some assets failed to load, using procedural fallbacks:",s)}const a=Je(),t=document.getElementById("game-container");new Pt(t,a).start(),console.log("[Perun] Game started.")}ei().catch(a=>{console.error("[Perun] Boot failed:",a);const t=document.getElementById("loading");t&&(t.textContent="Ошибка запуска: "+a.message)});
